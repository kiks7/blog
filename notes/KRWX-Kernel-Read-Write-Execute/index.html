<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Introduction github project: https://github.com/kiks7/KRWX
During the last few months/year I was studying and approaching the Kernel Exploitation subject and during this journey I developed few tools that assissted me (and currently assist) on better understanding specific topics."><title>KRWX: Kernel Read Write Execute</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://1day.dev//icon.png><link href=https://1day.dev/styles.7153093e4d1bbb584a28469cadfa3f88.min.css rel=stylesheet><link href=https://1day.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://1day.dev/js/darkmode.e6934a61ff52b65bd16cdf94b370f112.min.js></script>
<script src=https://1day.dev/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://1day.dev/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://1day.dev/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://1day.dev/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://1day.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://1day.dev/",fetchData=Promise.all([fetch("https://1day.dev/indices/linkIndex.5804227e032d5ef9d35a4e55a19e9d48.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://1day.dev/indices/contentIndex.242a3ec1e25ae3a70edbad2412371b2d.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://1day.dev",!1,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://1day.dev",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/1day.dev\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://1day.dev/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://1day.dev/>ðŸ‘¾ @kiks</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>KRWX: Kernel Read Write Execute</h1><p class=meta>Last updated
Mar 14, 2022</p><ul class=tags><li><a href=https://1day.dev/tags/Exploitation/>Exploitation</a></li><li><a href=https://1day.dev/tags/Linux/>Linux</a></li><li><a href=https://1day.dev/tags/Kernel/>Kernel</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#what>What</a></li><li><a href=#why>Why</a></li><li><a href=#how>How</a></li><li><a href=#examples>Examples</a><ol><li><a href=#allocate-free-and-read-arbitrary-chunks>Allocate, free and read arbitrary chunks</a></li><li><a href=#use-after-free>Use-After-Free</a></li></ol></li><li><a href=#setup>Setup</a></li><li><a href=#conclusions>Conclusions</a></li></ol></nav></details></aside><a href=#introduction><h2 id=introduction><span class=hanchor arialabel=Anchor># </span>Introduction</h2></a><p>github project:
<a href=https://github.com/kiks7/KRWX rel=noopener>https://github.com/kiks7/KRWX</a></p><p>During the last few months/year I was studying and approaching the Kernel Exploitation subject and during this journey I developed few tools that assissted me (and currently assist) on better understanding specific topics. Today I want to release my favourine one: KRWX (<strong>K</strong>ernel <strong>R</strong>ead <strong>W</strong>rite <strong>E</strong>xecute). It is a simple LKM (Linux Kernel Module) that lets you play with kernel memory, allocate and free kernel objects directly from user-land!</p><a href=#what><h2 id=what><span class=hanchor arialabel=Anchor># </span>What</h2></a><p>The main goal of this tool is to use kernel functions from userland (from C code) in order to avoid slower kernel debugging and developing of kernel modules to demostrate specific vulnerabilities (instead, you can emulate them with provided IOCTLs). Also, it can assist the exploitation phase.
These are the project main features (all these features are accessible from a low level user from user-land):</p><ul><li>Read and write into kernel memory</li><li>Read entire blocks of memory</li><li>Arbitrary allocate objects directly calling <code>kmalloc</code></li><li>Arbitrary <code>kfree</code> objects (and also free arbitrary addresses, if you want)</li><li>Allocate/free multiple objects</li><li>Log every <code>copy_[from|to]_user</code>/ <code>kmalloc</code>/<code>kfree</code> called by the KRWX module through hooking (readable from <code>dmesg</code>).</li></ul><p>Mainly, a more powerful read and write primitive :]</p><a href=#why><h2 id=why><span class=hanchor arialabel=Anchor># </span>Why</h2></a><p>Initially I was writing this module to study the SLUB memory allocator in Linux by allocating, freeing and re-allocating arbitrary chunks easily from an userland process. That automatically leads to study also some exploitation techniques that, with this module, I found a lot easier to understand since you can easily play with kernel memory as you are the god of your system. Then I started to heavily use it for multiple purposes and that&rsquo;s the reason why I&rsquo;m sharing it.</p><a href=#how><h2 id=how><span class=hanchor arialabel=Anchor># </span>How</h2></a><p>These are some exported functions:</p><ul><li><code>void* kmalloc(size_t arg_size, gfp_t flags)</code> -> Allocate a chunk with specific <code>size</code> and <code>flag</code> options.</li><li><code>int kfree(void* address)</code> -> Free arbitrary chunks by their <code>address</code> (also, you can free arbitrary memory).</li><li><code>unsigned long int kread64(void* address)</code> -> Read 8 bytes of memory at <code>address</code>.</li><li><code>int kwrite64(void* address, uint64_t value)</code> -> Write 8 bytes specified by <code>value</code> into <code>address</code>.</li><li><code>void read_memory(void* start_address, size_t size)</code> -> Read <code>size</code> amount of memory starting from <code>start_address</code>.</li></ul><p>And, since one of my favourite hobby is overengineer and I&rsquo;m lazy enough to do not want to write loops everytime:</p><ul><li><code>void multiple_kmalloc(void** array, uint32_t n_objs, uint32_t size)</code> -> Allocate <code>n_objs</code> number of objects with specified <code>size</code> and return addresses in <code>array</code>.</li><li><code>void multiple_kfree(void** array, uint64_t to_free[], uint64_t to_free_size)</code> -> Free specified addresses in <code>to_free</code> from <code>array</code> (<code>to_free_size</code> is the size of the <code>to_free</code> array).</li></ul><p>If you&rsquo;re interested in the source code feel free to check out the github project.</p><a href=#examples><h2 id=examples><span class=hanchor arialabel=Anchor># </span>Examples</h2></a><a href=#allocate-free-and-read-arbitrary-chunks><h3 id=allocate-free-and-read-arbitrary-chunks><span class=hanchor arialabel=Anchor># </span>Allocate, free and read arbitrary chunks</h3></a><p>You can find the full source code in <code>example/01.c</code>. Here will follows some snippets and a little walkthrough.</p><p>First, include the external library and call its initialization function (<code>init_krwx</code>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;./lib/krwx.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=n>init_krwx</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>[..]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span></code></pre></td></tr></table></div></div><p>So, 10 chunks with size 256 are allocated using <code>multiple_kmalloc</code>, and the memory of the 7th allocation is read using <code>read_memory</code> after writing <code>0x4141414141414141</code> at its first bytes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>void</span><span class=o>*</span> <span class=n>chunks</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>multiple_kmalloc</span><span class=p>(</span><span class=o>&amp;</span><span class=n>chunks</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>256</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>kwrite64</span><span class=p>(</span><span class=n>chunks</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=mh>0x4141414141414141</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>read_memory</span><span class=p>(</span><span class=n>chunks</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=mh>0x10</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>The indexes 3, 4 and 7 of the <code>chunks</code> array are freed using <code>multiple_kfree</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=n>to_free</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>7</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>multiple_kfree</span><span class=p>(</span><span class=o>&amp;</span><span class=n>chunks</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>to_free</span><span class=p>,</span> <span class=p>(</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>to_free</span><span class=p>)</span> <span class=o>/</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>uint64_t</span><span class=p>)</span> <span class=p>)</span> <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Once they are freed, new chunks with the same size are allocated and initialized with <code>0x4343434343434343</code>, and the memory of the 7h freed chunk is displayed using <code>read_memory</code> again:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>kwrite64</span><span class=p>(</span><span class=n>kmalloc</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=n>_GFP_KERN</span><span class=p>),</span> <span class=mh>0x4343434343434343</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>kwrite64</span><span class=p>(</span><span class=n>kmalloc</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=n>_GFP_KERN</span><span class=p>),</span> <span class=mh>0x4343434343434343</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>kwrite64</span><span class=p>(</span><span class=n>kmalloc</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=n>_GFP_KERN</span><span class=p>),</span> <span class=mh>0x4343434343434343</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>kwrite64</span><span class=p>(</span><span class=n>kmalloc</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=n>_GFP_KERN</span><span class=p>),</span> <span class=mh>0x4343434343434343</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>kwrite64</span><span class=p>(</span><span class=n>kmalloc</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=n>_GFP_KERN</span><span class=p>),</span> <span class=mh>0x4343434343434343</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>read_memory</span><span class=p>(</span><span class=n>chunks</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=mh>0x10</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>The result is:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocating <span class=m>10</span> chunks with size <span class=m>256</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocated @0xffffffc00503b900
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocated @0xffffffc00503b600
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocated @0xffffffc00503b100
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocated @0xffffffc00503bc00
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocated @0xffffffc00503b400
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocated @0xffffffc00503b000
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocated @0xffffffc00503b500
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocated @0xffffffc00503b800
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocated @0xffffffc00503ba00
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Allocated @0xffffffc00503bd00
</span></span><span class=line><span class=cl>0xffffffc00503b800:     0x4141414141414141 0xffffffc0001a8928
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Freeing @0xffffffc00503bc00
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Freeing @0xffffffc00503b400
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Freeing @0xffffffc00503b800
</span></span><span class=line><span class=cl>0xffffffc00503b800:     0x4343434343434343 0xffffffc0001a8928
</span></span></code></pre></td></tr></table></div></div><p>With few lines of code has been demostrated how our 7th chunk has been replaced with a new one after it has been freed (the <code>read_memory</code> targeted the <code>chunks[7]</code>).
As simple as it is, it has been written for demonstration purposes.</p><a href=#use-after-free><h3 id=use-after-free><span class=hanchor arialabel=Anchor># </span>Use-After-Free</h3></a><p>To simulate a UAF scenario it&rsquo;s simple as few lines of code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>void</span><span class=o>*</span> <span class=n>chunk</span> <span class=o>=</span> <span class=n>kmalloc</span><span class=p>(</span><span class=o>&lt;</span><span class=n>SIZE</span><span class=o>&gt;</span><span class=p>,</span> <span class=o>&lt;</span><span class=n>FLAGS</span><span class=o>&gt;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>kfree</span><span class=p>(</span><span class=n>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Allocate your target chunk
</span></span></span><span class=line><span class=cl><span class=c1>// Simulate UAF using k[write|read]64()
</span></span></span></code></pre></td></tr></table></div></div><p>For example, if we want to simulate an attack scenario where we want to replace our vulnerable freed chunk with a target object (for example an <code>iovec</code> struct) we can allocate a chunk with <code>kmalloc</code> and later <code>kfree</code> it just before allocating the target structure:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=c1>// Allocate the vulnerable object
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span><span class=o>*</span> <span class=n>chunk</span> <span class=o>=</span> <span class=n>kmalloc</span><span class=p>(</span><span class=mi>150</span><span class=p>,</span> <span class=n>_GFP_KERN</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=c1>// Allocate target object
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>iovec</span> <span class=n>iov</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>iov_buf</span><span class=p>[</span><span class=mh>0x100</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>iov</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=n>iov_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>iov</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mh>0x1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>iov</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>iov_base</span> <span class=o>=</span> <span class=n>iov_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>iov</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>iov_len</span> <span class=o>=</span> <span class=mh>0x1337</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>pp</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>pipe</span><span class=p>(</span><span class=n>pp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>fork</span><span class=p>()){</span>
</span></span><span class=line><span class=cl>	<span class=n>kfree</span><span class=p>(</span><span class=n>chunk</span><span class=p>);</span> <span class=c1>// Freeing the chunk just before allocating the iovec
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>readv</span><span class=p>(</span><span class=n>pp</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>iov</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span> <span class=c1>// allocate iovec and blocks (keeping the object in the kernel) 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span> <span class=c1>// Give time to the child process
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>read_memory</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Then, with <code>read_memory</code> we can show the block of memory in our interest and as you can see from the following output, our arbitrary allocated/freed object has been replaced with the target object:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>Allocated</span> <span class=n>chunk</span> <span class=err>@</span><span class=mh>0xffffffc0052c5a00</span>
</span></span><span class=line><span class=cl><span class=mh>0xffffffc0052c5a00</span><span class=o>:</span>     <span class=mh>0x0000007fd311ff58</span> <span class=mh>0x0000000000001000</span>
</span></span><span class=line><span class=cl><span class=mh>0xffffffc0052c5a10</span><span class=o>:</span>     <span class=mh>0x0000007fd311ff58</span> <span class=mh>0x0000000000001337</span>
</span></span><span class=line><span class=cl><span class=mh>0xffffffc0052c5a20</span><span class=o>:</span>     <span class=mh>0x0000000000000000</span> <span class=mh>0x0000000000000000</span>
</span></span><span class=line><span class=cl><span class=mh>0xffffffc0052c5a30</span><span class=o>:</span>     <span class=mh>0x0000000000000000</span> <span class=mh>0x0000000000000000</span>
</span></span></code></pre></td></tr></table></div></div><p>Instead of just print the content, you can simulate a UAF read/write using <code>k[read|write]</code> and play with it.</p><p>The full code of this example can be found in <code>client/example/02.c</code></p><a href=#setup><h2 id=setup><span class=hanchor arialabel=Anchor># </span>Setup</h2></a><p>To compile the module change the <code>K</code> variable in the <code>Makefile</code> with your compiled kernel root directory and compile with <code>make</code>, then <code>insmod</code>.</p><a href=#conclusions><h2 id=conclusions><span class=hanchor arialabel=Anchor># </span>Conclusions</h2></a><p>Personally, I used it to study the SLUB allocator, understand UAF/Heap Overflows/Double Free/userfaultd and some hardening features in the kernel, but it can assist the exploitation phase too or more. Blog posts on some Kernel vulnerabilities and their attack methodologies will follow these months and this module will come useful to demonstrate them. So, stay tuned and enjoy !</p><p>PS. The &ldquo;Execute&rdquo; part of the name will be a future implementation to control <code>pc/rip</code>.</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/ data-ctx="notes/KRWX - Kernel Read Write Execute" data-src=/ class=internal-link>ðŸ‘¾ KIKS.</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://1day.dev/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Powered by <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2022</p><ul><li><a href=https://1day.dev/>Home</a></li><li><a href=https://twitter.com/kiks7_7>Twitter</a></li><li><a href=https://github.com/jackyzha0>Github</a></li></ul></footer></div></div></body></html>