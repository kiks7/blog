<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Introduction This blog post is about a manually Reverse Engineered challenge I have written for this year NoHat24 security conference. The conference was a blast and we also did (as Hacktive Security) our best to contribute also with a worskhop on Linux Kernel Fuzzing."><title>A Reverse Engineering Journey Walkthrough</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://1day.dev//icon.png><link href=https://1day.dev/styles.7153093e4d1bbb584a28469cadfa3f88.min.css rel=stylesheet><link href=https://1day.dev/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://1day.dev/js/darkmode.e6934a61ff52b65bd16cdf94b370f112.min.js></script>
<script src=https://1day.dev/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://1day.dev/js/popover.53ad9a087e3feeaaa12b63bfd02d923b.min.js></script>
<script src=https://1day.dev/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://1day.dev/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://1day.dev/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://1day.dev/",fetchData=Promise.all([fetch("https://1day.dev/indices/linkIndex.f95908f70ec33c60c8fcda9ef7621f27.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://1day.dev/indices/contentIndex.12361a335f59b10e9254b6bffacdd390.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://1day.dev",!1,!0)},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'â€™':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/1day.dev\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-BZ6HJYMG3K"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BZ6HJYMG3K",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://1day.dev/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://1day.dev/>ðŸ‘¾ @kiks</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>A Reverse Engineering Journey Walkthrough</h1><p class=meta>Last updated
Nov 4, 2024</p><ul class=tags><li><a href=https://1day.dev/tags/Reverse-Engineering/>Reverse engineering</a></li><li><a href=https://1day.dev/tags/Linux/>Linux</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#the-beginning-of-the-journey>The beginning of the journey</a><ol><li><a href=#first-approach>First approach</a></li><li><a href=#parse-client-message>Parse client message</a></li><li><a href=#initialize-an-undefied-object>Initialize an undefied object</a></li><li><a href=#scratching-the-structure-definition>Scratching the structure definition</a></li><li><a href=#more-parsing>More parsing</a></li><li><a href=#command-0x10>Command 0x10</a></li><li><a href=#command-0x20>Command 0x20</a></li><li><a href=#chain-all-pieces>Chain all pieces</a></li></ol></li><li><a href=#libc-signature-resolution-alternative>libc signature resolution alternative</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#appendix>Appendix</a><ol><li><a href=#the-cleaned-code>The cleaned code</a></li><li><a href=#exploit>Exploit</a></li></ol></li></ol></nav></details></aside><a href=#introduction><h2 id=introduction><span class=hanchor arialabel=Anchor># </span>Introduction</h2></a><p>This blog post is about a manually Reverse Engineered challenge I have written for this year
<a href=https://www.nohat.it/ rel=noopener>NoHat24</a> security conference. The conference was a blast and we also did (as
<a href=https://www.hacktivesecurity.com/ rel=noopener>Hacktive Security</a>) our best to contribute also with a
<a href=https://www.nohat.it/workshops#alessandro_groppo rel=noopener>worskhop</a> on Linux Kernel Fuzzing. The challenge is a compiled C/C++ binary that implements a custom TCP protocol that can be reversed and exploited to obtain the flag. The blog post objective is to guide a beginner person with a step by step and detailed walkthrough of the whole Reverse Engineering journey, dealing with a statically compiled binary. For the best experience, it is highly suggested to download the target binary from
<a rel=noopener class="internal-link broken" data-src=TODO>here TODO</a> and try to replicate described steps.</p><a href=#the-beginning-of-the-journey><h2 id=the-beginning-of-the-journey><span class=hanchor arialabel=Anchor># </span>The beginning of the journey</h2></a><p>First things first, let&rsquo;s see what our binary is with a simple <code>file</code> command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ file challenge
</span></span><span class=line><span class=cl>challenge: ELF 64-bit LSB executable, x86-64, version <span class=m>1</span> <span class=o>(</span>GNU/Linux<span class=o>)</span>, statically linked, BuildID<span class=o>[</span>sha1<span class=o>]=</span>975594a6398b8d39078294cbd2a09f100dfd6643, <span class=k>for</span> GNU/Linux 3.2.0, stripped
</span></span></code></pre></td></tr></table></div></div><p>We can immediately take some notes on few things that are interesting for the reverse engineering phase: the binary is <strong>static</strong> (e.g. not linked with dynamic libraries) and <strong>stripped</strong> (e.g. no symbols). Both things will make it harder to understand the inner logic of the targeted program.</p><p>Also, the <code>strings</code> utility suggests that we are dealing with C++ too:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ strings challenge <span class=p>|</span> grep std
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl>std::bad_alloc
</span></span><span class=line><span class=cl>std::bad_array_new_length
</span></span><span class=line><span class=cl>std::bad_cast
</span></span><span class=line><span class=cl>std::bad_typeid
</span></span><span class=line><span class=cl>std::allocator
</span></span><span class=line><span class=cl>std::basic_string
</span></span><span class=line><span class=cl>std::string
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span></code></pre></td></tr></table></div></div><a href=#first-approach><h3 id=first-approach><span class=hanchor arialabel=Anchor># </span>First approach</h3></a><p>After having opened the binary in Ghidra and having identified its <code>main</code> function (<code>FUN_00405b16</code>) , it is possible to understand the first behaviors through logging strings:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>undefined8</span> <span class=nf>FUN_00405b16</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>uVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined8</span> <span class=n>uVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>in_FS_OFFSET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>local_48</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>local_44</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_40</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_3c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined2</span> <span class=n>local_38</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined2</span> <span class=n>local_36</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>local_34</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined</span> <span class=n>local_28</span> <span class=p>[</span><span class=mi>24</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>local_10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>local_10</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>local_40</span> <span class=o>=</span> <span class=n>FUN_00524bf0</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>local_48</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uVar1</span> <span class=o>=</span> <span class=n>FUN_0051b890</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>FUN_004cf660</span><span class=p>(</span><span class=n>uVar1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>local_40</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>uVar3</span> <span class=o>=</span> <span class=n>FUN_00476a40</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Failed to create socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>FUN_004753c0</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>iVar2</span> <span class=o>=</span> <span class=n>FUN_00524bb0</span><span class=p>(</span><span class=n>local_40</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_48</span><span class=p>,</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>iVar2</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>uVar3</span> <span class=o>=</span> <span class=n>FUN_00476a40</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Failed to setsockopt on socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>FUN_004753c0</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>thunk_FUN_004ef5e0</span><span class=p>(</span><span class=o>&amp;</span><span class=n>local_38</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>local_38</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_34</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_36</span> <span class=o>=</span> <span class=n>FUN_005257d0</span><span class=p>(</span><span class=mh>0x51</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar2</span> <span class=o>=</span> <span class=n>FUN_005249d0</span><span class=p>(</span><span class=n>local_40</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_38</span><span class=p>,</span><span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>iVar2</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar3</span> <span class=o>=</span> <span class=n>FUN_00476a40</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Bind failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>FUN_004753c0</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>FUN_005216a0</span><span class=p>(</span><span class=n>local_40</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>iVar2</span> <span class=o>=</span> <span class=n>FUN_00524a00</span><span class=p>(</span><span class=n>local_40</span><span class=p>,</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span> <span class=o>&lt;</span> <span class=n>iVar2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>uVar3</span> <span class=o>=</span> <span class=n>FUN_00476a40</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005cacc0</span><span class=p>,</span><span class=s>&#34;Server listening..&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>FUN_004753c0</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span><span class=p>(</span> <span class=nb>true</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>local_44</span> <span class=o>=</span> <span class=mh>0x10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=n>local_3c</span> <span class=o>=</span> <span class=n>FUN_00524930</span><span class=p>(</span><span class=n>local_40</span><span class=p>,</span><span class=n>local_28</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_44</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=k>if</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span> <span class=o>&lt;</span> <span class=n>local_3c</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=n>uVar3</span> <span class=o>=</span> <span class=n>FUN_00476a40</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Accept failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=n>FUN_004753c0</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>uVar3</span> <span class=o>=</span> <span class=n>FUN_00476a40</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005cacc0</span><span class=p>,</span><span class=s>&#34;Connection accepted&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>FUN_004753c0</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>FUN_0040597c</span><span class=p>(</span><span class=n>local_3c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>FUN_005216a0</span><span class=p>(</span><span class=n>local_3c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>while</span><span class=p>(</span> <span class=nb>true</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar3</span> <span class=o>=</span> <span class=n>FUN_00476a40</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Listen failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>FUN_004753c0</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>FUN_005216a0</span><span class=p>(</span><span class=n>local_40</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>local_10</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>    <span class=n>FUN_005256e0</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Since the binary is statically linked and stripped, common libc functions do not have explicit names and needs to be reconstructed. To perform such operation, strings can be used to guess the function name and can be confirmed through a more reliable method: go to the function definition and extract the <code>eax</code> register used in the <code>syscall</code> instruction. For example, the function <code>FUN_00524930</code> can be guessed as an <code>accept</code> syscall through the <code>Accept failed</code> log message (hence, the <code>FUN_00476a40</code> is something log related) and confirmed with its assembly, where <code>0x2d</code> corresponds to the <code>accept</code> syscall (
<a href="https://syscalls.mebeim.net/?table=x86/64/x64/v6.7" rel=noopener>Linux kernel syscall tables</a>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>0052493</span><span class=nl>d:</span> <span class=nf>MOV</span> <span class=no>EAX</span><span class=p>,</span><span class=mi>0x2b</span>
</span></span><span class=line><span class=cl><span class=err>00524942:</span> <span class=nf>SYSCALL</span>
</span></span></code></pre></td></tr></table></div></div><p>Also, the first accepted parameter of the <code>accept</code> syscall is a <code>socket</code> file descriptor and can be used to identify the <code>socket</code> call at <code>FUN_00524bf0</code> since the returned value is assigned into the <code>local_40</code> variable.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>undefined8</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>uVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined8</span> <span class=n>uVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>in_FS_OFFSET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>local_48</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>local_44</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>socket</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>sock_accept</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined2</span> <span class=n>local_38</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined2</span> <span class=n>local_36</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>local_34</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined</span> <span class=n>local_28</span> <span class=p>[</span><span class=mi>24</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>stack_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>stack_cookie</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>socket</span> <span class=o>=</span> <span class=o>::</span><span class=n>socket</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>local_48</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uVar1</span> <span class=o>=</span> <span class=n>FUN_0051b890</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>FUN_004cf660</span><span class=p>(</span><span class=n>uVar1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>socket</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>uVar3</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Failed to create socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>iVar2</span> <span class=o>=</span> <span class=n>FUN_00524bb0</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_48</span><span class=p>,</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>iVar2</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>uVar3</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Failed to setsockopt on socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>thunk_FUN_004ef5e0</span><span class=p>(</span><span class=o>&amp;</span><span class=n>local_38</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>local_38</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_34</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_36</span> <span class=o>=</span> <span class=n>FUN_005257d0</span><span class=p>(</span><span class=mh>0x51</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar2</span> <span class=o>=</span> <span class=n>bind</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_38</span><span class=p>,</span><span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>iVar2</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar3</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Bind failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>socket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>iVar2</span> <span class=o>=</span> <span class=n>listen</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span> <span class=o>&lt;</span> <span class=n>iVar2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>uVar3</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005cacc0</span><span class=p>,</span><span class=s>&#34;Server listening..&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span><span class=p>(</span> <span class=nb>true</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>local_44</span> <span class=o>=</span> <span class=mh>0x10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=n>sock_accept</span> <span class=o>=</span> <span class=n>accept</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span><span class=n>local_28</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_44</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=k>if</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span> <span class=o>&lt;</span> <span class=n>sock_accept</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=n>uVar3</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Accept failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>uVar3</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005cacc0</span><span class=p>,</span><span class=s>&#34;Connection accepted&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>FUN_0040597c</span><span class=p>(</span><span class=n>sock_accept</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>close</span><span class=p>(</span><span class=n>sock_accept</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>while</span><span class=p>(</span> <span class=nb>true</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar3</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Listen failed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>close</span><span class=p>(</span><span class=n>socket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>stack_cookie</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>    <span class=n>__stack_check</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>By applying these techniques on the entire <code>main</code> function, we can obtain a much more cleaner code and identify two key parts:</p><ul><li>The server uses an <code>AF_INET</code> socket and binds to port <code>81</code> (<code>&local_38</code> is a <code>struct sockaddr *</code>). The <code>81</code> port can be quickly identified, without a proper cast, through the <code>local_36</code> variable that is instead an offset of the <code>local_38</code> stack variable.</li><li>The file descriptor returned from the <code>accept</code> syscall (the client connection) is parsed through the <code>FUN_0040597c</code> function that can be renamed, for that reason, to <code>parse_client_message</code>.</li></ul><a href=#parse-client-message><h3 id=parse-client-message><span class=hanchor arialabel=Anchor># </span>Parse client message</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>void</span> <span class=nf>parse_client_message</span><span class=p>(</span><span class=kt>int</span> <span class=n>socket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>cVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined8</span> <span class=n>uVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>in_FS_OFFSET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined</span> <span class=n>local_228</span> <span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>local_224</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>ushort</span> <span class=n>local_222</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined</span> <span class=n>local_118</span> <span class=p>[</span><span class=mi>264</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>local_10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>local_10</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>thunk_FUN_004ef5e0</span><span class=p>(</span><span class=n>local_118</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x108</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>iVar2</span> <span class=o>=</span> <span class=n>FUN_00524a30</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span><span class=n>local_118</span><span class=p>,</span><span class=mh>0x108</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>iVar2</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>uVar3</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Error reading from socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>socket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FUN_00405f5e</span><span class=p>(</span><span class=n>local_228</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>cVar1</span> <span class=o>=</span> <span class=n>FUN_00405f8e</span><span class=p>(</span><span class=n>local_228</span><span class=p>,</span><span class=n>local_118</span><span class=p>,(</span><span class=kt>long</span><span class=p>)</span><span class=n>iVar2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>cVar1</span> <span class=o>==</span> <span class=sc>&#39;\x01&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>FUN_00406018</span><span class=p>(</span><span class=n>local_228</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>local_224</span> <span class=o>==</span> <span class=mh>0x10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>FUN_00405453</span><span class=p>(</span><span class=n>local_228</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>local_224</span> <span class=o>==</span> <span class=mh>0x20</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>FUN_00405520</span><span class=p>(</span><span class=n>local_228</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>local_222</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>FUN_00524af0</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span><span class=n>local_228</span><span class=p>,(</span><span class=n>ulong</span><span class=p>)</span><span class=n>local_222</span> <span class=o>+</span> <span class=mi>8</span><span class=p>,</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>uVar3</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Invalid message received&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar3</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>local_10</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>    <span class=n>__stack_check</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The newly identified <code>parse_client_message</code> function seems to do what we have guessed: parse a message received from the client (<code>Error reading from socket</code> where <code>FUN_00524a30</code> is <code>recvfrom</code>) and perform some validation (e.g. <code>Invalid message received</code>).
By applying the same techniques previously described we can make further assumptions:</p><ul><li><code>local_118</code> is the second parameter of the <code>recvfrom</code> syscall. Since the second parameter of <code>recvfrom</code> is a <code>char*</code> buffer we can safely rename it to <code>buffer</code> and change its type (using the Ghidra <code>Retype Variable</code>) to <code>char[256]</code>.</li><li>The <code>FUN_00405f5e</code> seems to init a structure (or object since we are dealing with C++) inside the <code>undefined</code> stack variable <code>local_228</code> (now renamed to <code>undefined_obj</code>).</li><li>The just initialized <code>undefined_obj</code> is used as the first parameter to the function <code>FUN_00405f8e</code> that accepts two more parameters: the <code>buffer</code> passed to the <code>recvfrom</code> and its returned result (e.g. number of received bytes) through the local <code>iVar3</code> (renamed to <code>bytes_received</code>). We can use these information to retype the targeted function signature with appropriate parameter types.</li></ul><a href=#initialize-an-undefied-object><h3 id=initialize-an-undefied-object><span class=hanchor arialabel=Anchor># </span>Initialize an undefied object</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>undefined8</span> <span class=nf>FUN_00405f8e</span><span class=p>(</span><span class=n>undefined8</span> <span class=o>*</span><span class=n>undefined_obj</span><span class=p>,</span><span class=kt>char</span> <span class=o>*</span><span class=n>buffer</span><span class=p>,</span><span class=n>ulong</span> <span class=n>param_3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined8</span> <span class=n>uVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>param_3</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>uVar1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>undefined_obj</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>undefined8</span> <span class=o>*</span><span class=p>)</span><span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>short</span> <span class=o>*</span><span class=p>)</span><span class=n>undefined_obj</span> <span class=o>==</span> <span class=o>-</span><span class=mh>0x9a</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=n>ushort</span> <span class=o>*</span><span class=p>)((</span><span class=kt>long</span><span class=p>)</span><span class=n>undefined_obj</span> <span class=o>+</span> <span class=mi>6</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mh>0x101</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>thunk_FUN_004ef2e0</span><span class=p>(</span><span class=n>undefined_obj</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span><span class=n>buffer</span> <span class=o>+</span> <span class=mi>8</span><span class=p>,</span><span class=o>*</span><span class=p>(</span><span class=kt>short</span> <span class=o>*</span><span class=p>)((</span><span class=kt>long</span><span class=p>)</span><span class=n>undefined_obj</span> <span class=o>+</span> <span class=mi>6</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar1</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>uVar1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>uVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Function <code>FUN_00405f8e</code> first checks that <code>param_3</code> is more than <code>8</code> bytes and returns <code>0</code> otherwise.
The first <code>if</code> condition is misleading through the decompiled code, but much more clear from the assembly instruction: <code>CMP AX, 0xff66</code>. We are checking that the first bytes of the received buffer contains the <code>0xff66</code> constant (some sort of a magic value?) and returning <code>0</code> if not. The next conditional statement is checking 2 bytes (deduced from the <code>ushort</code> cast of the offset access and confirmed from the <code>AX</code> usage inside <code>CMP AX,0x100</code>). If the extracted value at offset <code>0x6</code> is below <code>0x101</code> (256 in decimal, a classic buffer size :}) we continue with a weird call to <code>thunk_FUN_004ef2e0</code> and we set the return result (<code>uVar1</code> now renamed to <code>ret</code>) to 1.</p><p>The <code>thunk_FUN_004ef2e0</code> function is not that straightforward to understand and can be statically identified by deeply reversing the function or dynamically using a debugger and verifying its behavior. It is accepting three parameters:</p><ol><li><code>undefined_obj + 1</code> where the <code>+1</code> is not properly &ldquo;correct&rdquo;. Since we are presumably dealing with an object, it should be treated as a <code>void*</code>. By re-typing the value to a more appropriate type, it become <code>undefined_obj + 8</code> as the assembly instruction.</li><li><code>buffer + 8</code> that is the same offset as the first parameter.</li><li><code>undefined_obj + 6</code> that has been previously discussed and could be some sort of size (due to the <code>256</code> constant).</li></ol><p>It seems that the first 2 parameters are some sort of source and destination (also dealing with the same offset) and the last parameter a size. Is it a <code>memcpy</code>? A quick session with <code>gdb</code> actually reveals that the behavior, and the function signature, match the <code>memcpy</code> function call. Nice!</p><a href=#scratching-the-structure-definition><h3 id=scratching-the-structure-definition><span class=hanchor arialabel=Anchor># </span>Scratching the structure definition</h3></a><p>With these first hints, we can perform some asssumptions:</p><ol><li>First bytes of the received buffer should contains a magic value <code>0xff66</code> that corresponds to 2 bytes (16 bits).</li><li>At offset <code>0x6</code> we should have a size related field of 2 bytes (remember the previous <code>CMP, 0x100</code> instruction and the <code>memcpy</code> parameter).</li><li>Starting from offset <code>0x8</code>, we are copying the entire buffer, for a maximum of <code>256</code> bytes, inside our undefined object.</li></ol><p>With that information, we can start creating a potential structure from <code>Data Type Manager</code> => <code>Data Types</code> => <code>challenge</code> => <code>New</code> => <code>Structure</code>:</p><p><img src=/notes/images/rev/1.png width=auto></p><p>After the creation of the new structure and the retype of the <code>undefined_obj</code>, we have a much cleaner and easier to understand function (renamed into <code>copy_from_buffer</code>). Also, we can retype the same value from the caller function and all subsequent calls.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>undefined8</span> <span class=nf>copy_from_buffer</span><span class=p>(</span><span class=k>struct</span> <span class=n>custom_message</span> <span class=o>*</span><span class=n>undefined_obj</span><span class=p>,</span><span class=kt>char</span> <span class=o>*</span><span class=n>buffer</span><span class=p>,</span><span class=n>ulong</span> <span class=n>param_3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined8</span> <span class=n>buffer_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>param_3</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>buffer_ptr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>buffer_ptr</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>undefined8</span> <span class=o>*</span><span class=p>)</span><span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined_obj</span><span class=o>-&gt;</span><span class=n>magic</span> <span class=o>=</span> <span class=p>(</span><span class=kt>short</span><span class=p>)</span><span class=n>buffer_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined_obj</span><span class=o>-&gt;</span><span class=n>undefined</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=p>)((</span><span class=n>ulong</span><span class=p>)</span><span class=n>buffer_ptr</span> <span class=o>&gt;&gt;</span> <span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined_obj</span><span class=o>-&gt;</span><span class=n>undefined</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=p>)((</span><span class=n>ulong</span><span class=p>)</span><span class=n>buffer_ptr</span> <span class=o>&gt;&gt;</span> <span class=mh>0x18</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined_obj</span><span class=o>-&gt;</span><span class=n>undefined</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=p>)((</span><span class=n>ulong</span><span class=p>)</span><span class=n>buffer_ptr</span> <span class=o>&gt;&gt;</span> <span class=mh>0x20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined_obj</span><span class=o>-&gt;</span><span class=n>undefined</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=p>)((</span><span class=n>ulong</span><span class=p>)</span><span class=n>buffer_ptr</span> <span class=o>&gt;&gt;</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined_obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=p>(</span><span class=kt>short</span><span class=p>)((</span><span class=n>ulong</span><span class=p>)</span><span class=n>buffer_ptr</span> <span class=o>&gt;&gt;</span> <span class=mh>0x30</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>undefined_obj</span><span class=o>-&gt;</span><span class=n>magic</span> <span class=o>==</span> <span class=mh>0xff66</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>undefined_obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&lt;</span> <span class=mh>0x101</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>memcpy</span><span class=p>(</span><span class=n>undefined_obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>,</span><span class=n>buffer</span> <span class=o>+</span> <span class=mi>8</span><span class=p>,</span><span class=n>undefined_obj</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer_ptr</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer_ptr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>buffer_ptr</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>buffer_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Note:</strong> <code>buffer_ptr</code> is a rename to make it easier to read the code after the <code>else</code> statement. However, it is also used form the same routine as the return result variable. For that reason, it is returning <code>buffer_ptr</code> but instead it is <code>0</code> or <code>1</code>.</p><a href=#more-parsing><h3 id=more-parsing><span class=hanchor arialabel=Anchor># </span>More parsing</h3></a><p>Coming back to the renamed <code>parse_client_message</code>, a conditional statement verifies the content of <code>undefined_obj.undefined[2]</code> against <code>0x10</code> or <code>0x20</code>. If it doesn&rsquo;t match any of these two values, it will set the <code>size</code> object value to 0 and continue the execution. The execution, shared also with the two conditional cases, goes directly into a <code>sendto</code> syscall (renamed from <code>FUN_00524af0</code>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>sendto</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span><span class=o>&amp;</span><span class=n>undefined_obj</span><span class=p>,(</span><span class=n>ulong</span><span class=p>)</span><span class=n>undefined_obj</span><span class=p>.</span><span class=n>size</span> <span class=o>+</span> <span class=mi>8</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>The sent buffer is the same object we are analyzing and the number of bytes to be sent through the <code>sendto</code> syscall (third parameter) is the <code>undefined_obj.size</code> previously set to zero plus <code>0x8</code>.</p><p>If the condition matches <code>0x10</code> the routine calls <code>FUN_00405453</code> or <code>FUN_00405520</code> if it matches <code>0x20</code> and they both accept the address of the <code>undefined_obj</code> as a parameter. Also, from that condition, we can continue to add information on our structure. We are accessing the byte (due to the <code>MOVZXZ EAX, AL</code> before the <code>CMP</code> instruction) at offset <code>0x2</code> of the <code>undefined</code> member. We can add a member on our <code>struct custom_message</code> with the name of <code>command</code>, since it seems to redirect the execution based on its value, and put a size of <code>uint8_t</code> due to the <code>AL</code> register access and the comparison of the two hexadecimal values:</p><p><img src=/notes/images/rev/2.png width=auto></p><a href=#command-0x10><h3 id=command-0x10><span class=hanchor arialabel=Anchor># </span>Command 0x10</h3></a><p>We can rename <code>FUN_00405453</code> to <code>command_0x10</code> and <code>FUN_00405520</code> to <code>command_0x20</code>. This is useful to simplify further references.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>void</span> <span class=nf>command_0x10</span><span class=p>(</span><span class=k>struct</span> <span class=n>custom_message</span> <span class=o>*</span><span class=n>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>ushort</span> <span class=o>*</span><span class=n>puVar2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>byte</span> <span class=n>bVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>in_FS_OFFSET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>ushort</span> <span class=n>local_22</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>stack_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>stack_cookie</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>local_22</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>ushort</span> <span class=o>*</span><span class=p>)</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>local_22</span> <span class=o>&lt;</span> <span class=mh>0x100</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=mh>0x900</span> <span class=o>&lt;</span> <span class=n>local_22</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>iVar1</span> <span class=o>=</span> <span class=n>FUN_004cf650</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>bVar3</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=p>)</span><span class=n>iVar1</span> <span class=o>+</span> <span class=p>(</span><span class=kt>char</span><span class=p>)(</span><span class=n>iVar1</span> <span class=o>/</span> <span class=mh>0x3f</span><span class=p>)</span> <span class=o>*</span> <span class=o>-</span><span class=mh>0x3f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>puVar2</span> <span class=o>=</span> <span class=p>(</span><span class=n>ushort</span> <span class=o>*</span><span class=p>)</span><span class=n>FUN_004060a8</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005c9d80</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_22</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>puVar2</span> <span class=o>=</span> <span class=p>(</span><span class=n>ushort</span><span class=p>)</span><span class=n>bVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\x01&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>bVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>stack_cookie</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>    <span class=n>__stack_check</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The first thing we can see, after having retyped the parameter into <code>struct custom_message*</code>, as observed from the caller, is the dereference of <code>obj->undefined</code> as a <code>ushort</code> (2 bytes). The first validation is that that value is between <code>0x100</code> and <code>0x900</code>, otherwise we return while setting the object size to <code>0x0</code>. If the validation step is valid the things become more confusing:</p><ol><li>The result of <code>FUN_004cf650</code> (<code>iVar1</code>) is divided by <code>0x3f</code> and summed with itself, then multiplied with <code>0x3f</code> (=><code>bVar3</code>) and the result is stored in the pointer returned from <code>FUN_004060a8</code>.</li><li><code>FUN_004060a8</code> involves two parameters: a global variable (due to its <code>.bss</code> section location) <code>DAT_005c9d8</code> and the byte extracted from <code>obj->undefined</code> as the second parameter.</li></ol><p>The <code>DAT_005c9d8</code> address, by seeing its references, is also used in the function <code>command_0x20</code> but in the opposite way: instead of storing a value inside the returned pointer, it retrieves it, always using the <code>obj->undefined</code> member of our declared structure. Since the internals of the <code>FUN_004060a8</code> are pretty confusing, let&rsquo;s superficially rename the function into a generic <code>store_and_get</code> and proceed the analysis. After storing the calculated value, the object parameter is directly modified: its <code>size</code> to <code>0x2</code>, <code>payload[0]</code> to <code>0x1</code> and <code>obj->payload[1]</code> with the calculated value. By seeing the <code>payload</code> access we can suppose that we have two more <code>byte</code> members instead of the remaining <code>char</code>. A weird thing is that now the <code>structure->payload</code> become <code>char[254]</code>, a weird size for a payload, but that&rsquo;s what we are observing. Since we know the logic behind the second parameter, we can rename its newly created member at that offset with <code>calculated_value</code>, leaving the other one with an undefined logic with <code>undefined_3</code>.</p><p><img src=/notes/images/rev/3.png width=auto></p><p>After returning to <code>parse_client_message</code>, as observed before, the modified object is sent back to the client. That means that the same object as input is used as output for the client socket.</p><a href=#command-0x20><h3 id=command-0x20><span class=hanchor arialabel=Anchor># </span>Command 0x20</h3></a><p>If <code>undefined_obj.command</code>, in <code>parse_client_message</code>, contains <code>0x20</code> instead, the function <code>command_0x20</code> is called:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>void</span> <span class=nf>command_0x20</span><span class=p>(</span><span class=k>struct</span> <span class=n>custom_message</span> <span class=o>*</span><span class=n>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>byte</span> <span class=n>bVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>cVar2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined2</span> <span class=o>*</span><span class=n>puVar4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined8</span> <span class=n>uVar5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>in_FS_OFFSET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined2</span> <span class=n>local_168</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>ushort</span> <span class=n>local_166</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_164</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_160</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_15c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_158</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_154</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_150</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>local_14c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>local_148</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_144</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>local_140</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined</span> <span class=n>local_138</span> <span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined8</span> <span class=n>local_128</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>local_10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>local_10</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>local_168</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>undefined2</span> <span class=o>*</span><span class=p>)</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>puVar4</span> <span class=o>=</span> <span class=p>(</span><span class=n>undefined2</span> <span class=o>*</span><span class=p>)</span><span class=n>store_and_get</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005c9d80</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_168</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>bVar1</span> <span class=o>=</span> <span class=p>(</span><span class=n>byte</span><span class=p>)</span><span class=o>*</span><span class=n>puVar4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>bVar1</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>local_14c</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>local_138</span> <span class=o>=</span> <span class=p>(</span><span class=n>undefined</span>  <span class=p>[</span><span class=mi>16</span><span class=p>])</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>local_128</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>local_166</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>local_164</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>local_140</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>local_160</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>local_15c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>((((</span><span class=n>local_15c</span> <span class=o>&lt;</span> <span class=mi>3</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>             <span class=p>(</span><span class=n>local_166</span> <span class=o>=</span> <span class=p>(</span><span class=n>ushort</span><span class=p>)</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_164</span> <span class=o>+</span> <span class=o>-</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>             <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>uint</span><span class=p>)</span><span class=n>local_166</span> <span class=o>&lt;=</span> <span class=mh>0xff</span> <span class=o>-</span> <span class=n>local_164</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>local_166</span> <span class=o>&lt;</span> <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=n>local_166</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>local_140</span> <span class=o>=</span> <span class=n>FUN_004ed140</span><span class=p>(</span><span class=n>local_166</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>(</span><span class=n>undefined</span> <span class=o>*</span><span class=p>)(</span><span class=n>local_140</span> <span class=o>+</span> <span class=p>(</span><span class=n>ulong</span><span class=p>)</span><span class=n>local_166</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>memcpy</span><span class=p>(</span><span class=n>local_140</span><span class=p>,</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_164</span> <span class=o>+</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=n>local_166</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=n>local_158</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>local_158</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>uint</span><span class=p>)</span><span class=n>local_166</span><span class=p>;</span> <span class=n>local_158</span> <span class=o>=</span> <span class=n>local_158</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>(</span><span class=n>byte</span> <span class=o>*</span><span class=p>)(</span><span class=n>local_140</span> <span class=o>+</span> <span class=n>local_158</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>byte</span> <span class=o>*</span><span class=p>)(</span><span class=n>local_140</span> <span class=o>+</span> <span class=n>local_158</span><span class=p>)</span> <span class=o>^</span> <span class=n>bVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>local_138</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_15c</span> <span class=o>*</span> <span class=mi>8</span><span class=p>)</span> <span class=o>=</span> <span class=n>local_140</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_160</span> <span class=o>=</span> <span class=n>local_160</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_164</span> <span class=o>=</span> <span class=n>local_164</span> <span class=o>+</span> <span class=n>local_166</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>local_15c</span> <span class=o>=</span> <span class=n>local_15c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>local_160</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>local_154</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar3</span> <span class=o>=</span> <span class=n>thunk_FUN_004ef8a0</span><span class=p>(</span><span class=n>local_138</span><span class=p>.</span><span class=n>_0_8_</span><span class=p>,</span><span class=o>&amp;</span><span class=n>DAT_00568030</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>iVar3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>local_154</span> <span class=o>=</span> <span class=mh>0x40</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar3</span> <span class=o>=</span> <span class=n>thunk_FUN_004ef8a0</span><span class=p>(</span><span class=n>local_138</span><span class=p>.</span><span class=n>_0_8_</span><span class=p>,</span><span class=o>&amp;</span><span class=n>DAT_00568035</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>iVar3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>local_154</span> <span class=o>=</span> <span class=mh>0x41</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar3</span> <span class=o>=</span> <span class=n>thunk_FUN_004ef8a0</span><span class=p>(</span><span class=n>local_138</span><span class=p>.</span><span class=n>_0_8_</span><span class=p>,</span><span class=s>&#34;write&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>iVar3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>local_154</span> <span class=o>=</span> <span class=mh>0x42</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>local_148</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>local_154</span> <span class=o>==</span> <span class=mh>0x42</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar5</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005cacc0</span><span class=p>,</span><span class=s>&#34;EXEC_WRITE Not implemented&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar5</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>local_154</span> <span class=o>&lt;</span> <span class=mh>0x43</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>local_154</span> <span class=o>==</span> <span class=mh>0x40</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>cVar2</span> <span class=o>=</span> <span class=n>FUN_00405355</span><span class=p>(</span><span class=n>local_138</span><span class=p>.</span><span class=n>_8_8_</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>cVar2</span> <span class=o>==</span> <span class=sc>&#39;\x01&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=o>-&gt;</span><span class=n>undefined_3</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=o>-&gt;</span><span class=n>undefined_3</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>local_154</span> <span class=o>==</span> <span class=mh>0x41</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>local_160</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>local_148</span> <span class=o>=</span> <span class=n>FUN_004ce310</span><span class=p>(</span><span class=n>local_128</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>local_144</span> <span class=o>=</span> <span class=n>FUN_004053be</span><span class=p>(</span><span class=o>&amp;</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>undefined_3</span><span class=p>,</span><span class=n>local_138</span><span class=p>.</span><span class=n>_8_8_</span><span class=p>,</span><span class=n>local_148</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>local_144</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint16_t</span><span class=p>)</span><span class=n>local_144</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=k>for</span> <span class=p>(</span><span class=n>local_150</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>local_150</span> <span class=o>&lt;</span> <span class=n>local_144</span><span class=p>;</span> <span class=n>local_150</span> <span class=o>=</span> <span class=n>local_150</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_150</span> <span class=o>+</span> <span class=o>-</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_150</span> <span class=o>+</span> <span class=o>-</span><span class=mi>2</span><span class=p>]</span> <span class=o>^</span> <span class=n>bVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>local_10</span> <span class=o>==</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>  <span class=n>__stack_check</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>In this case, we are dealing with a much longer function. <code>store_and_get</code> function is the first one that is called and retrieve its value, maybe based on the <code>obj->undefined</code> value. We can then rename <code>pVar1</code> with <code>stored_value</code> and we can see that if it is <code>0x0</code>, the function sets <code>obj->size</code> to <code>0x0</code> and return, a common pattern also identified previously that seems to be related to some sort of failure in the message validation process. That means that the <code>store_and_get</code> function must return something to proceed (<strong>hence we need to first call <code>command_0x10</code> to set it?</strong>).</p><a href=#the-tedious-while-loop><h4 id=the-tedious-while-loop><span class=hanchor arialabel=Anchor># </span>The tedious while loop</h4></a><p>The first while loop inside the <code>command_0x20</code> seems like one of the first main blocks of the function and contains a pretty confusing condition, let&rsquo;s cut it down:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>local_164</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>local_15c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>    
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>local_15c</span> <span class=o>&lt;</span> <span class=mi>3</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>local_166</span> <span class=o>=</span> <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=n>local_164</span> <span class=o>-</span> <span class=mi>2</span><span class=p>],</span> <span class=n>local_166</span> <span class=o>&lt;=</span> <span class=mh>0xff</span> <span class=o>-</span> <span class=n>local_164</span><span class=p>))</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>local_166</span> <span class=o>&lt;</span> <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>		  <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>	   <span class=p>(</span><span class=n>local_166</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ..
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>memcpy</span><span class=p>(</span><span class=n>local_140</span><span class=p>,</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_164</span> <span class=o>+</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=n>local_166</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>local_164</span> <span class=o>=</span> <span class=n>local_164</span> <span class=o>+</span> <span class=n>local_166</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>local_15c</span> <span class=o>=</span> <span class=n>local_15c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Step by step:</p><ol><li><code>local_15c</code> is zero initialized, incremented inside the loop and checked if it is less than <code>3</code>. It is clearly an <code>index</code> that tells us that it will loop through the cycle at least 3 times. Let&rsquo;s rename it to <code>idx</code>.</li><li><code>local_166</code> is assigned to <code>obj->payload[local_164 - 2]</code>, where <code>local_164</code> is first initialized with 0 and then incremented with <code>1</code> and the value of <code>local_166</code> inside the loop. <code>local_166</code> is later used as the size parameter of the <code>memcpy</code> function, while <code>local_164</code> as an offset to <code>obj_payload</code> as the source argument.<ol><li>Since the two local variables are pretty confusing, let&rsquo;s start renaming things into something more easy to read with the limited information we have gathered: <code>memcpy_size</code> and <code>memcpy_source_offset</code>.</li></ol></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>memcpy_source_offset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>local_15c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>    
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>local_15c</span> <span class=o>&lt;</span> <span class=mi>3</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>memcpy_size</span> <span class=o>=</span> <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=n>memcpy_source_offset</span> <span class=o>-</span> <span class=mi>2</span><span class=p>],</span> <span class=n>memcpy_size</span> <span class=o>&lt;=</span> <span class=mh>0xff</span> <span class=o>-</span> <span class=n>memcpy_source_offset</span><span class=p>))</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>memcpy_size</span> <span class=o>&lt;</span> <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>		  <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>	   <span class=p>(</span><span class=n>memcpy_size</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ..
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>memcpy</span><span class=p>(</span><span class=n>local_140</span><span class=p>,</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>memcpy_source_offset</span> <span class=o>+</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=n>memcpy_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy_source_offset</span> <span class=o>=</span> <span class=n>memcpy_source_offset</span> <span class=o>+</span> <span class=n>memcpy_size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>local_15c</span> <span class=o>=</span> <span class=n>local_15c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Now we can use more meaningful names and things are more clear:</p><ol start=3><li><code>memcpy_size</code> is retrieved at each loop through an offset (<code>memcpy_source_offset</code>) inside the <code>obj->payload</code>. Given these two variables, the content of <code>obj->payload</code> is copied inside the <code>local_140</code> variable (dynamic parsing).<ul><li>Also, <code>memcpy_size</code> must not be zero or more than <code>0xff - memcpy_source_offset</code> to continue the loop.</li></ul></li></ol><p>Let&rsquo;s see more code to understand the entire loop process:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>local_138</span> <span class=o>=</span> <span class=p>(</span><span class=n>undefined</span>  <span class=p>[</span><span class=mi>16</span><span class=p>])</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>((((</span><span class=n>idx</span> <span class=o>&lt;</span> <span class=mi>3</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>		 <span class=p>(</span><span class=n>memcpy_size</span> <span class=o>=</span> <span class=p>(</span><span class=n>ushort</span><span class=p>)</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[(</span><span class=kt>long</span><span class=p>)</span><span class=n>memcpy_source_offset</span> <span class=o>+</span> <span class=o>-</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		 <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>uint</span><span class=p>)</span><span class=n>memcpy_size</span> <span class=o>&lt;=</span> <span class=mh>0xff</span> <span class=o>-</span> <span class=n>memcpy_source_offset</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>memcpy_size</span> <span class=o>&lt;</span> <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	   <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>memcpy_size</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>local_140</span> <span class=o>=</span> <span class=n>FUN_004ed140</span><span class=p>(</span><span class=n>memcpy_size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=n>undefined</span> <span class=o>*</span><span class=p>)(</span><span class=n>local_140</span> <span class=o>+</span> <span class=p>(</span><span class=n>ulong</span><span class=p>)</span><span class=n>memcpy_size</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy</span><span class=p>(</span><span class=n>local_140</span><span class=p>,</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>memcpy_source_offset</span> <span class=o>+</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=n>memcpy_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>local_158</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>local_158</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>uint</span><span class=p>)</span><span class=n>memcpy_size</span><span class=p>;</span> <span class=n>local_158</span> <span class=o>=</span> <span class=n>local_158</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=p>(</span><span class=n>byte</span> <span class=o>*</span><span class=p>)(</span><span class=n>local_140</span> <span class=o>+</span> <span class=n>local_158</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>byte</span> <span class=o>*</span><span class=p>)(</span><span class=n>local_140</span> <span class=o>+</span> <span class=n>local_158</span><span class=p>)</span> <span class=o>^</span> <span class=n>bVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>local_138</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>idx</span> <span class=o>*</span> <span class=mi>8</span><span class=p>)</span> <span class=o>=</span> <span class=n>local_140</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>local_160</span> <span class=o>=</span> <span class=n>local_160</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy_source_offset</span> <span class=o>=</span> <span class=n>memcpy_source_offset</span> <span class=o>+</span> <span class=n>memcpy_size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>idx</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ol start=4><li><code>local_140</code> is assigned with the result of the <code>FUN_004ed140</code> with the <code>memcpy_size</code> as the parameter. Identify this function is easy as just open the function and see the error log with <code>"malloc.c",0xd17,"__libc_malloc"</code> on it. We can rename it to <code>malloc</code> and know that <code>local_140</code> holds a pointer to an allocated memory.<ol><li>We put a <code>0x0</code> value at the offset of <code>memcpy_size</code>. Maybe the NULL character at the end of the string.</li></ol></li><li><code>local_140</code> is used as the destination of the previously described <code>memcpy</code> (renamed it to <code>memcpy_dest</code>).</li><li>The next <code>for</code> loop iterates on each character copied inside the <code>memcpy_dest</code> pointer using <code>local_158</code> as an index (renamed to <code>inner_idx</code>) and XOR its with <code>stored_value</code>.<ol><li>Here we go! We have found how <code>stored_value</code> is used and we can rename it to <code>xor_key</code>. We can also rename the <code>obj->undefined</code> into something like <code>xor_key_derivate</code> since it is used to derive in some way (through the <code>store_and_get</code> function) the XOR key.</li></ol></li><li>Just after the <code>for</code> loop we have an assignment of the pointer <code>local_140</code> (now <code>memcpy_dest</code>) to <code>local_138</code> with the <code>idx</code> index multiplied by 8. We can retype the <code>local_140</code> array (declared from ghidra as <code>undefined local_138 [16];</code>) into a <code>char*</code> for that reasons (and rename it into <code>char_ptr_array</code>):
2. We are storing a pointer into each slot (the multiplication of 8 is the size of each entry e.g. the pointer size)
3. We were NULL terminating the memory. That means that we are dealing with some sort of string parsing.</li><li>Furthemore, <code>local_160</code> is incremented by 1 at each iteration and later checked against 2 (if it is less we return with <code>obj->size = 0</code>) and later again inside another loop. We don&rsquo;t know the context of it but at least know that, in order to continue the function flow, we need to iterate the loop at least 2 times. With poor fantasy, let&rsquo;s rename it <code>at_least_2</code>.</li></ol><p>Finally, the loop is far more readable:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>local_14c</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>memcpy_size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>memcpy_source_offset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>memcpy_dest</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>at_least_2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>((((</span><span class=n>idx</span> <span class=o>&lt;</span> <span class=mi>3</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>		 <span class=p>(</span><span class=n>memcpy_size</span> <span class=o>=</span> <span class=p>(</span><span class=n>ushort</span><span class=p>)</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[(</span><span class=kt>long</span><span class=p>)</span><span class=n>memcpy_source_offset</span> <span class=o>+</span> <span class=o>-</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		 <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>uint</span><span class=p>)</span><span class=n>memcpy_size</span> <span class=o>&lt;=</span> <span class=mh>0xff</span> <span class=o>-</span> <span class=n>memcpy_source_offset</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>memcpy_size</span> <span class=o>&lt;</span> <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	   <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>memcpy_size</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy_dest</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=n>memcpy_size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy_dest</span><span class=p>[</span><span class=n>memcpy_size</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy</span><span class=p>(</span><span class=n>memcpy_dest</span><span class=p>,</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>memcpy_source_offset</span> <span class=o>+</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=n>memcpy_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>inner_idx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>inner_idx</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>uint</span><span class=p>)</span><span class=n>memcpy_size</span><span class=p>;</span> <span class=n>inner_idx</span> <span class=o>=</span> <span class=n>inner_idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>memcpy_dest</span><span class=p>[</span><span class=n>inner_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>memcpy_dest</span><span class=p>[</span><span class=n>inner_idx</span><span class=p>]</span> <span class=o>^</span> <span class=n>stored_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>char_ptr_array</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>memcpy_dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>at_least_2</span> <span class=o>=</span> <span class=n>at_least_2</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy_source_offset</span> <span class=o>=</span> <span class=n>memcpy_source_offset</span> <span class=o>+</span> <span class=n>memcpy_size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>idx</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#more-parsing-1><h4 id=more-parsing-1><span class=hanchor arialabel=Anchor># </span>More parsing</h4></a><p>To summarize the previous loop, we have seen the parsing of the client message by splitting it into multiple &ldquo;chunks&rdquo; based on the message specified size (<code>memcpy_size</code> retrieved, and validated, directly from the message) and storing them inside a <code>char*</code> array: <code>char_ptr_array</code>. Let&rsquo;s continue our journey.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>at_least_2</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>local_154</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>iVar3</span> <span class=o>=</span> <span class=n>thunk_FUN_004ef8a0</span><span class=p>(</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=o>&amp;</span><span class=n>DAT_00568030</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>iVar3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>local_154</span> <span class=o>=</span> <span class=mh>0x40</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>iVar3</span> <span class=o>=</span> <span class=n>thunk_FUN_004ef8a0</span><span class=p>(</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=o>&amp;</span><span class=n>DAT_00568035</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>iVar3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>local_154</span> <span class=o>=</span> <span class=mh>0x41</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>iVar3</span> <span class=o>=</span> <span class=n>thunk_FUN_004ef8a0</span><span class=p>(</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=s>&#34;write&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>iVar3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>local_154</span> <span class=o>=</span> <span class=mh>0x42</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>local_148</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>local_154</span> <span class=o>==</span> <span class=mh>0x42</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>uVar5</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005cacc0</span><span class=p>,</span><span class=s>&#34;EXEC_WRITE Not implemented&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar5</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>local_154</span> <span class=o>&lt;</span> <span class=mh>0x43</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>local_154</span> <span class=o>==</span> <span class=mh>0x40</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	  <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>cVar2</span> <span class=o>=</span> <span class=n>FUN_00405355</span><span class=p>(</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	  <span class=k>if</span> <span class=p>(</span><span class=n>cVar2</span> <span class=o>==</span> <span class=sc>&#39;\x01&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>obj</span><span class=o>-&gt;</span><span class=n>undefined_3</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=p>}</span>
</span></span><span class=line><span class=cl>	  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>obj</span><span class=o>-&gt;</span><span class=n>undefined_3</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>local_154</span> <span class=o>==</span> <span class=mh>0x41</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	  <span class=k>if</span> <span class=p>(</span><span class=n>at_least_2</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>local_148</span> <span class=o>=</span> <span class=n>FUN_004ce310</span><span class=p>(</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>		<span class=n>local_144</span> <span class=o>=</span> <span class=n>FUN_004053be</span><span class=p>(</span><span class=o>&amp;</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>undefined_3</span><span class=p>,</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>local_148</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>local_144</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		  <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		  <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint16_t</span><span class=p>)</span><span class=n>local_144</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		  <span class=k>for</span> <span class=p>(</span><span class=n>local_150</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>local_150</span> <span class=o>&lt;</span> <span class=n>local_144</span><span class=p>;</span> <span class=n>local_150</span> <span class=o>=</span> <span class=n>local_150</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_150</span> <span class=o>+</span> <span class=o>-</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>				 <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_150</span> <span class=o>+</span> <span class=o>-</span><span class=mi>2</span><span class=p>]</span> <span class=o>^</span> <span class=n>stored_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		  <span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	  <span class=p>}</span>
</span></span><span class=line><span class=cl>	  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>If <code>at_least_2</code> is, <em>at least</em> (:}), 2 we have multiple conditional statements on the first retrieved string (at index 0) of <code>char_ptr_array</code>. The function <code>thunk_FUN_004ef8a0</code> accepts a constant (they all reside inside the <code>.rodata</code> section) as the second parameter and the mentioned string as the first. The tree constants are (two of them needs to be converted manually from ghidra into a <code>string</code>): stat, read and write. Based on the return value of <code>iVar3</code> we are setting <code>local_154</code> to <code>0x40</code>, <code>0x41</code> or <code>0x42</code> that are later used inside multiple <code>if</code> statements.</p><p>If <code>local_154</code> is <code>0x42</code>, our previously renamed <code>may_log</code> function writes <code>"EXEC_WRITE Not implemented"</code> and the same for on <code>0x40</code> and <code>0x41</code> (like a classic <code>switch</code> statement) but with the difference that we do not have the <code>Not implemented</code> log message. Following the logic of this log function, we can suppose that <code>EXEC_WRITE</code> is the source code representation of a command that can be set from the <code>thunk_FUN_004ef8a0</code> call with the <code>write</code> as a second parameter (since it sets the variable to <code>0x42</code>). We can rename <code>local_154</code> to <code>exec_command</code>.</p><p>If <code>exec_command</code> is <code>0x40</code> there is a call to <code>FUN_00405355</code> that seems to return something similar to a boolean result. If the return result is <code>0x1</code>, <code>obj->undefined4</code> is set accordingly and the same for <code>0x0</code>.</p><a href=#stat---fun_00405355><h4 id=stat---fun_00405355><span class=hanchor arialabel=Anchor># </span>stat - <code>FUN_00405355</code></h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>FUN_00405355</span><span class=p>(</span><span class=n>undefined8</span> <span class=n>param_1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>in_FS_OFFSET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined</span> <span class=n>local_a8</span> <span class=p>[</span><span class=mi>152</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>local_10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>local_10</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>iVar1</span> <span class=o>=</span> <span class=n>FUN_00522440</span><span class=p>(</span><span class=n>param_1</span><span class=p>,</span><span class=n>local_a8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>local_10</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>    <span class=n>__stack_check</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>iVar1</span> <span class=o>==</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This function is really simple since it just calls one function and returns its value (ignore the <code>local_10</code> that is the stack cookie). The called function <code>FUN_00522440</code> is the statically linked <code>stat</code> function since it clearly calls a syscall with the <code>EAX</code> register set to <code>0x106</code>(<code>newfstatat</code> syscall). The return result of <code>stat</code> (and subsequently of <code>FUN_00405355</code>) indicates if the file exists or not. We can rename that function to <code>exec_stat</code>.</p><a href=#read---fun_004ce310--fun_004053be><h4 id=read---fun_004ce310--fun_004053be><span class=hanchor arialabel=Anchor># </span>read - <code>FUN_004ce310</code> & <code>FUN_004053be</code></h4></a><p>If the <code>exec_command</code> inside <code>command_0x20</code> matches <code>0x41</code>, the first check is that <code>at_least_2</code> is equals to 3 and if it is not we return with <code>obj->size</code> set to zero. Otherwise, we call <code>FUN_004ce310</code> with <code>char_ptr_array[2]</code> as parameter and the result will be the third parameter of <code>FUN_004053be</code> (marked as <code>int</code> in the function signature from ghidra). That parameter is later used inside the function <code>FUN_00522080</code> that is an <code>lseek</code> syscall. The second parameter of <code>lseek</code> is an <code>off_t</code> (<code>long int</code>) type, meaning that ghidra &ldquo;guessed&rdquo; it pretty correctly. For that reasons, it seems that from the second index of <code>char_ptr_array</code> we are retrieving, in some way, an integer value that we are passing to <code>FUN_004053be</code> and using it as an offset to something through <code>lseek</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>FUN_004053be</span><span class=p>(</span><span class=kt>long</span> <span class=n>param_1</span><span class=p>,</span><span class=n>undefined8</span> <span class=n>param_2</span><span class=p>,</span><span class=kt>int</span> <span class=n>param_3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>lVar2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>iVar1</span> <span class=o>=</span> <span class=n>FUN_005220d0</span><span class=p>(</span><span class=n>param_2</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>iVar1</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>iVar1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>lVar2</span> <span class=o>=</span> <span class=n>lseek</span><span class=p>(</span><span class=n>iVar1</span><span class=p>,(</span><span class=kt>long</span><span class=p>)</span><span class=n>param_3</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>lVar2</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar1</span> <span class=o>=</span> <span class=n>FUN_005223a0</span><span class=p>(</span><span class=n>iVar1</span><span class=p>,</span><span class=n>param_1</span><span class=p>,</span><span class=mh>0xff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>(</span><span class=n>undefined</span> <span class=o>*</span><span class=p>)(</span><span class=n>param_1</span> <span class=o>+</span> <span class=n>iVar1</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>iVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Function <code>FUN_004053be</code> is called with <code>obj->undefined_3</code> as the first parameter and <code>char_ptr</code>array as the second one.</p><p><code>FUN_005220d0</code> is a call to the <code>openat</code> syscall, meaning that we are opening the file at <code>param_2</code> as read-only. Let&rsquo;s rename it into <code>filename</code> and retype to <code>char*</code>. If <code>openat</code> succeeds, <code>lseek</code> is called with the offset specified by <code>param_3</code> (renamed to <code>offset</code>) on the opened file handle. It then proceeds to call <code>FUN_005223a0</code> (&ldquo;proxy&rdquo; function to the <code>read</code> syscall) with the <code>param_1</code> (that is <code>obj->undefined3</code>) as the <code>char* buf</code> parameter. That means that inside <code>obj->undefined3</code> there is the content of the read file at the specified offset.
This the cleaned code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>int</span> <span class=nf>exec_open</span><span class=p>(</span><span class=kt>long</span> <span class=n>param_1</span><span class=p>,</span><span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span><span class=kt>int</span> <span class=n>offset</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>lVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>fp</span> <span class=o>=</span> <span class=n>openat</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>lVar1</span> <span class=o>=</span> <span class=n>lseek</span><span class=p>(</span><span class=n>fp</span><span class=p>,(</span><span class=kt>long</span><span class=p>)</span><span class=n>offset</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>lVar1</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span><span class=n>param_1</span><span class=p>,</span><span class=mh>0xff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>(</span><span class=n>undefined</span> <span class=o>*</span><span class=p>)(</span><span class=n>param_1</span> <span class=o>+</span> <span class=n>fp</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The return result is the <code>read</code> return value (number of read bytes) and the value, at <code>command_0x20</code> function, is stored inside <code>obj->size</code>. It follows a <code>for</code> loop that XOR each character inside the <code>obj->payload</code> with the previously retrieved <code>stored_value</code>. However, we can see a strange array access: <code>obj->payload[(long)local_150 + -2]</code>. <code>local_150</code>, the <code>for</code> loop index initialized with zero, is used to access <code>-2</code> bytes before the array memory location? What a strange behavior.. or, maybe, we have made wrong assumptions before. Maybe the array starts 2 bytes before?</p><p>Let&rsquo;s re-think a little bit by re-watching our current struct definition:</p><p><img src=/notes/images/rev/4.png width=auto></p><p><code>payload[-2]</code> indicates <code>undefined_3</code>. We have set it due to the usage and the retrieval of a specific size in the offset of <code>calculated_size</code> and we still didn&rsquo;t know the value of the byte before (=><code>undefined_3</code>) but:</p><ul><li>Arguments (for example to the identified <code>exec_open</code> function) are dynamically generated into a local array (<code>char_ptr_array</code>) so the payload stores both the size (that is sanitized) and the content.</li><li><code>undefined_3</code> is used as the direct buffer output of the <code>read</code> syscall.</li><li>The <code>for</code> loop starts the xoring operation two indexes before the current definition (<code>-2</code>).</li></ul><p>For that reasons, let&rsquo;s try to remove <code>undefined_3</code> and <code>calculated_size</code> by replacing them with two extra bytes for <code>payload</code> instead:</p><p><img src=/notes/images/rev/5.png width=auto></p><p>With that change, the code seems far more congruent and readable.</p><a href=#chain-all-pieces><h3 id=chain-all-pieces><span class=hanchor arialabel=Anchor># </span>Chain all pieces</h3></a><p>After this intensive Reverse Engineering phase, we have recovered a much more understandable code (that you can find at the end <a class="internal-link broken"></a>) with ideas on how the program works:</p><ul><li>The client message must contain a well-defined structure with a constant value at the beginning, a command and the size of the entire message.</li><li>The command <code>0x10</code> sets a value that can be retrieved from the command <code>0x20</code>. This value is later used to XOR the content of the message like a basic encryption mechanism.</li><li>The command <code>0x20</code>, after few validation checks, parses an array of arguments dynamically and is able to execute few extra operations: read, write and stat.</li><li>The write operation is not implemented, while the stat is able to identify existing files and the read operation to read arbitrary files.</li><li>The read operation, from the command <code>0x20</code>, can be exploited in order to read the flag at <code>/home/pwnx/flag.txt</code> (as instructed in the webroot at port 80).</li></ul><p>To solve the challenge, it is necessary to initializes a session that returns a xoring key. The retrieved key is used to &ldquo;encrypt&rdquo; a further message that contains a read operation to the <code>/home/pwnx/flag.txt</code> file. The final python exploit can be found
<a rel=noopener class="internal-link broken" data-src=TODO>here TODO</a>.</p><a href=#libc-signature-resolution-alternative><h2 id=libc-signature-resolution-alternative><span class=hanchor arialabel=Anchor># </span>libc signature resolution alternative</h2></a><p>An alternative solution to retrieve function signatures for statically linked libc functions is to use something like
<a href=https://docs.hex-rays.com/user-guide/signatures/flirt rel=noopener>IDA FLIRT</a> or its
<a href=https://github.com/NWMonster/ApplySig rel=noopener>Ghidra ApplySig</a> alternative. This approach is well explained from Liveoverflow in the following video:
<a href="https://www.youtube.com/watch?v=CgGha_zLqlo" rel=noopener>Reversing Statically-Linked Binaries with Function Signatures</a>.</p><a href=#conclusion><h2 id=conclusion><span class=hanchor arialabel=Anchor># </span>Conclusion</h2></a><p>Hope you have enjoyed this RE journey. In the next blog post we are going to release the write-up for the binary exploitation challenge too that involves a custom allocator specifically written for that challenge! Stay tuned and happy hacking!</p><a href=#appendix><h2 id=appendix><span class=hanchor arialabel=Anchor># </span>Appendix</h2></a><a href=#the-cleaned-code><h3 id=the-cleaned-code><span class=hanchor arialabel=Anchor># </span>The cleaned code</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>void</span> <span class=nf>parse_client_message</span><span class=p>(</span><span class=kt>int</span> <span class=n>socket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>lVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>bytes_received</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined8</span> <span class=n>uVar2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>in_FS_OFFSET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>custom_message</span> <span class=n>undefined_obj</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>buffer</span> <span class=p>[</span><span class=mi>264</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>lVar1</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>thunk_FUN_004ef5e0</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x108</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>bytes_received</span> <span class=o>=</span> <span class=n>recvfrom</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span><span class=n>buffer</span><span class=p>,</span><span class=mh>0x108</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>bytes_received</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>uVar2</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Error reading from socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar2</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>close</span><span class=p>(</span><span class=n>socket</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>init_obj</span><span class=p>(</span><span class=o>&amp;</span><span class=n>undefined_obj</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>copy_from_buffer</span><span class=p>(</span><span class=o>&amp;</span><span class=n>undefined_obj</span><span class=p>,</span><span class=n>buffer</span><span class=p>,(</span><span class=kt>long</span><span class=p>)</span><span class=n>bytes_received</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>res</span> <span class=o>==</span> <span class=sc>&#39;\x01&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>FUN_00406018</span><span class=p>(</span><span class=o>&amp;</span><span class=n>undefined_obj</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>undefined_obj</span><span class=p>.</span><span class=n>command</span> <span class=o>==</span> <span class=mh>0x10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>command_0x10</span><span class=p>(</span><span class=o>&amp;</span><span class=n>undefined_obj</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>undefined_obj</span><span class=p>.</span><span class=n>command</span> <span class=o>==</span> <span class=mh>0x20</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>command_0x20</span><span class=p>(</span><span class=o>&amp;</span><span class=n>undefined_obj</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>undefined_obj</span><span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>sendto</span><span class=p>(</span><span class=n>socket</span><span class=p>,</span><span class=o>&amp;</span><span class=n>undefined_obj</span><span class=p>,(</span><span class=n>ulong</span><span class=p>)</span><span class=n>undefined_obj</span><span class=p>.</span><span class=n>size</span> <span class=o>+</span> <span class=mi>8</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>uVar2</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005caba0</span><span class=p>,</span><span class=s>&#34;Invalid message received&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar2</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>lVar1</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>    <span class=n>__stack_check</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>command_0x10</span><span class=p>(</span><span class=k>struct</span> <span class=n>custom_message</span> <span class=o>*</span><span class=n>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>ushort</span> <span class=o>*</span><span class=n>puVar2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>byte</span> <span class=n>bVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>in_FS_OFFSET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>ushort</span> <span class=n>obj_undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>stack_cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>stack_cookie</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>obj_undefined</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>ushort</span> <span class=o>*</span><span class=p>)</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>xor_key_derivate</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>obj_undefined</span> <span class=o>&lt;</span> <span class=mh>0x100</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=mh>0x900</span> <span class=o>&lt;</span> <span class=n>obj_undefined</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>iVar1</span> <span class=o>=</span> <span class=n>return_something</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>bVar3</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span><span class=p>)</span><span class=n>iVar1</span> <span class=o>+</span> <span class=p>(</span><span class=kt>char</span><span class=p>)(</span><span class=n>iVar1</span> <span class=o>/</span> <span class=mh>0x3f</span><span class=p>)</span> <span class=o>*</span> <span class=o>-</span><span class=mh>0x3f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>puVar2</span> <span class=o>=</span> <span class=p>(</span><span class=n>ushort</span> <span class=o>*</span><span class=p>)</span><span class=n>store_and_get</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005c9d80</span><span class=p>,</span><span class=o>&amp;</span><span class=n>obj_undefined</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>puVar2</span> <span class=o>=</span> <span class=p>(</span><span class=n>ushort</span><span class=p>)</span><span class=n>bVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>bVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>stack_cookie</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>    <span class=n>__stack_check</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>command_0x20</span><span class=p>(</span><span class=k>struct</span> <span class=n>custom_message</span> <span class=o>*</span><span class=n>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>lVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>byte</span> <span class=n>stored_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>cVar2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>iVar3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined2</span> <span class=o>*</span><span class=n>puVar4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined8</span> <span class=n>uVar5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>in_FS_OFFSET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined2</span> <span class=n>local_168</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>ushort</span> <span class=n>memcpy_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>memcpy_source_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>at_least_2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>inner_idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>exec_command</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>local_150</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>local_14c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined4</span> <span class=n>local_148</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>n_bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>memcpy_dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>char_ptr_array</span> <span class=p>[</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>lVar1</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>local_168</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>undefined2</span> <span class=o>*</span><span class=p>)</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>xor_key_derivate</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>puVar4</span> <span class=o>=</span> <span class=p>(</span><span class=n>undefined2</span> <span class=o>*</span><span class=p>)</span><span class=n>store_and_get</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005c9d80</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_168</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>stored_value</span> <span class=o>=</span> <span class=p>(</span><span class=n>byte</span><span class=p>)</span><span class=o>*</span><span class=n>puVar4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>stored_value</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>local_14c</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>memcpy_size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>memcpy_source_offset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>memcpy_dest</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>at_least_2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>((((</span><span class=n>idx</span> <span class=o>&lt;</span> <span class=mi>3</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>             <span class=p>(</span><span class=n>memcpy_size</span> <span class=o>=</span> <span class=p>(</span><span class=n>ushort</span><span class=p>)</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=n>memcpy_source_offset</span><span class=p>],</span>
</span></span><span class=line><span class=cl>             <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>uint</span><span class=p>)</span><span class=n>memcpy_size</span> <span class=o>&lt;=</span> <span class=mh>0xff</span> <span class=o>-</span> <span class=n>memcpy_source_offset</span><span class=p>))</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>memcpy_size</span> <span class=o>&lt;</span> <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>           <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>memcpy_size</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>memcpy_dest</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=n>memcpy_size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>memcpy_dest</span><span class=p>[</span><span class=n>memcpy_size</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>memcpy</span><span class=p>(</span><span class=n>memcpy_dest</span><span class=p>,</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>memcpy_source_offset</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span><span class=n>memcpy_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=n>inner_idx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>inner_idx</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>uint</span><span class=p>)</span><span class=n>memcpy_size</span><span class=p>;</span> <span class=n>inner_idx</span> <span class=o>=</span> <span class=n>inner_idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>memcpy_dest</span><span class=p>[</span><span class=n>inner_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>memcpy_dest</span><span class=p>[</span><span class=n>inner_idx</span><span class=p>]</span> <span class=o>^</span> <span class=n>stored_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>char_ptr_array</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>memcpy_dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>at_least_2</span> <span class=o>=</span> <span class=n>at_least_2</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>memcpy_source_offset</span> <span class=o>=</span> <span class=n>memcpy_source_offset</span> <span class=o>+</span> <span class=n>memcpy_size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>idx</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>at_least_2</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>exec_command</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar3</span> <span class=o>=</span> <span class=n>what_is_this</span><span class=p>(</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=s>&#34;stat&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>iVar3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>exec_command</span> <span class=o>=</span> <span class=mh>0x40</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar3</span> <span class=o>=</span> <span class=n>what_is_this</span><span class=p>(</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=s>&#34;read&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>iVar3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>exec_command</span> <span class=o>=</span> <span class=mh>0x41</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>iVar3</span> <span class=o>=</span> <span class=n>what_is_this</span><span class=p>(</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=s>&#34;write&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>iVar3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>exec_command</span> <span class=o>=</span> <span class=mh>0x42</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>local_148</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>exec_command</span> <span class=o>==</span> <span class=mh>0x42</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>uVar5</span> <span class=o>=</span> <span class=n>may_log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_005cacc0</span><span class=p>,</span><span class=s>&#34;EXEC_WRITE Not implemented&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>jmp_rsi</span><span class=p>(</span><span class=n>uVar5</span><span class=p>,</span><span class=n>FUN_00476340</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>exec_command</span> <span class=o>&lt;</span> <span class=mh>0x43</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>exec_command</span> <span class=o>==</span> <span class=mh>0x40</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>cVar2</span> <span class=o>=</span> <span class=n>exec_stat</span><span class=p>(</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>cVar2</span> <span class=o>==</span> <span class=mh>0x1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\x01&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>exec_command</span> <span class=o>==</span> <span class=mh>0x41</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>at_least_2</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>local_148</span> <span class=o>=</span> <span class=n>FUN_004ce310</span><span class=p>(</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=n>n_bytes</span> <span class=o>=</span> <span class=n>exec_open</span><span class=p>(</span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>,</span><span class=n>char_ptr_array</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>local_148</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>n_bytes</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uint16_t</span><span class=p>)</span><span class=n>n_bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=k>for</span> <span class=p>(</span><span class=n>local_150</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>local_150</span> <span class=o>&lt;</span> <span class=n>n_bytes</span><span class=p>;</span> <span class=n>local_150</span> <span class=o>=</span> <span class=n>local_150</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=n>local_150</span><span class=p>]</span> <span class=o>=</span> <span class=n>obj</span><span class=o>-&gt;</span><span class=n>payload</span><span class=p>[</span><span class=n>local_150</span><span class=p>]</span> <span class=o>^</span> <span class=n>stored_value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>obj</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>lVar1</span> <span class=o>==</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>  <span class=n>__stack_check</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>exec_stat</span><span class=p>(</span><span class=n>undefined8</span> <span class=n>param_1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>in_FS_OFFSET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>undefined</span> <span class=n>local_a8</span> <span class=p>[</span><span class=mi>152</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>local_10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>local_10</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>ret</span> <span class=o>=</span> <span class=n>stat</span><span class=p>(</span><span class=n>param_1</span><span class=p>,</span><span class=n>local_a8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>local_10</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>in_FS_OFFSET</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>    <span class=n>__stack_check</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>exec_open</span><span class=p>(</span><span class=kt>long</span> <span class=n>param_1</span><span class=p>,</span><span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span><span class=kt>int</span> <span class=n>offset</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>lVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=n>fp</span> <span class=o>=</span> <span class=n>openat</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>lVar1</span> <span class=o>=</span> <span class=n>lseek</span><span class=p>(</span><span class=n>fp</span><span class=p>,(</span><span class=kt>long</span><span class=p>)</span><span class=n>offset</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>lVar1</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span><span class=n>param_1</span><span class=p>,</span><span class=mh>0xff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>(</span><span class=n>undefined</span> <span class=o>*</span><span class=p>)(</span><span class=n>param_1</span> <span class=o>+</span> <span class=n>fp</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#exploit><h3 id=exploit><span class=hanchor arialabel=Anchor># </span>Exploit</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>struct</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>termcolor</span> <span class=kn>import</span> <span class=n>colored</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_info</span><span class=p>(</span><span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>colored</span><span class=p>(</span><span class=s2>&#34;[*] &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>,</span><span class=s2>&#34;cyan&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_ok</span><span class=p>(</span><span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>colored</span><span class=p>(</span><span class=s2>&#34;[+] &#34;</span><span class=o>+</span> <span class=nb>str</span><span class=p>,</span><span class=s2>&#34;green&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_error</span><span class=p>(</span><span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>colored</span><span class=p>(</span><span class=s2>&#34;[-] &#34;</span><span class=o>+</span> <span class=nb>str</span><span class=p>,</span><span class=s2>&#34;red&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_warning</span><span class=p>(</span><span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>colored</span><span class=p>(</span><span class=s2>&#34;[!!] &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>,</span><span class=s2>&#34;yellow&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>char</span> <span class=o>=</span> <span class=s2>&#34;x&#34;</span>
</span></span><span class=line><span class=cl><span class=n>signed_char</span> <span class=o>=</span> <span class=n>s_char</span> <span class=o>=</span> <span class=s2>&#34;b&#34;</span>
</span></span><span class=line><span class=cl><span class=n>unsigned_char</span> <span class=o>=</span> <span class=n>u_char</span> <span class=o>=</span> <span class=s2>&#34;B&#34;</span>
</span></span><span class=line><span class=cl><span class=n>_Bool</span> <span class=o>=</span> <span class=n>_bool</span> <span class=o>=</span> <span class=s2>&#34;?&#34;</span>
</span></span><span class=line><span class=cl><span class=n>short_int</span> <span class=o>=</span> <span class=n>s_int</span> <span class=o>=</span> <span class=s2>&#34;h&#34;</span>
</span></span><span class=line><span class=cl><span class=n>unsigned_short_int</span> <span class=o>=</span> <span class=n>u_s_int</span> <span class=o>=</span> <span class=s2>&#34;H&#34;</span>
</span></span><span class=line><span class=cl><span class=n>_int</span> <span class=o>=</span> <span class=s2>&#34;i&#34;</span>
</span></span><span class=line><span class=cl><span class=n>unsigned_int</span> <span class=o>=</span> <span class=n>u_int</span> <span class=o>=</span> <span class=s2>&#34;I&#34;</span>
</span></span><span class=line><span class=cl><span class=n>long_int</span> <span class=o>=</span> <span class=n>l_int</span> <span class=o>=</span> <span class=s2>&#34;l&#34;</span>
</span></span><span class=line><span class=cl><span class=n>unsigned_long_int</span> <span class=o>=</span> <span class=n>u_l_int</span> <span class=o>=</span> <span class=s2>&#34;L&#34;</span>
</span></span><span class=line><span class=cl><span class=n>long_long_int</span> <span class=o>=</span> <span class=n>l_l_int</span> <span class=o>=</span> <span class=s2>&#34;q&#34;</span>
</span></span><span class=line><span class=cl><span class=n>unsigned_long_long_int</span> <span class=o>=</span> <span class=n>u_l_l_int</span> <span class=o>=</span> <span class=s2>&#34;Q&#34;</span>
</span></span><span class=line><span class=cl><span class=n>_float</span> <span class=o>=</span> <span class=s2>&#34;f&#34;</span>
</span></span><span class=line><span class=cl><span class=n>_double</span> <span class=o>=</span> <span class=s2>&#34;d&#34;</span>
</span></span><span class=line><span class=cl><span class=n>char_array</span> <span class=o>=</span> <span class=s2>&#34;s&#34;</span>
</span></span><span class=line><span class=cl><span class=n>void</span> <span class=o>=</span> <span class=s2>&#34;P&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_byte</span><span class=p>(</span><span class=n>num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;&lt;B&#34;</span><span class=p>,</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_word</span><span class=p>(</span><span class=n>num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;&lt;H&#34;</span><span class=p>,</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_dword</span><span class=p>(</span><span class=n>num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;&lt;L&#34;</span><span class=p>,</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_qword</span><span class=p>(</span><span class=n>num</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pack</span><span class=p>(</span><span class=s2>&#34;&lt;Q&#34;</span><span class=p>,</span> <span class=n>num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>eazy_unpack</span><span class=p>(</span><span class=n>format_list</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># THe first one must be little/big endian ot newtork or what else</span>
</span></span><span class=line><span class=cl>    <span class=c1># Give back struct format from a list</span>
</span></span><span class=line><span class=cl>    <span class=n>form</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[eazy_struct] size of data: &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>ff</span> <span class=ow>in</span> <span class=n>format_list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>form</span> <span class=o>+=</span> <span class=n>ff</span> 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=n>form</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>ez</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Exception generated: &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>ez</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Packet</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>header</span> <span class=o>=</span> <span class=n>Header</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Get the packet in bytes to send</span>
</span></span><span class=line><span class=cl>        <span class=n>final_packet</span> <span class=o>=</span> <span class=nb>bytearray</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># Put the header inside the packet</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=nb>vars</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>header</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>item_value</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>header</span><span class=p>,</span> <span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>item_value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>print_warning</span><span class=p>(</span><span class=s2>&#34;[Packet.get] Item &#34;</span> <span class=o>+</span> <span class=n>item</span> <span class=o>+</span> <span class=s2>&#34; is None&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>final_packet</span> <span class=o>+=</span> <span class=n>item_value</span>
</span></span><span class=line><span class=cl>        <span class=c1># Put the body inside the packet</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        for item in vars(self.body):
</span></span></span><span class=line><span class=cl><span class=s2>            item_value = getattr(self.body, item)
</span></span></span><span class=line><span class=cl><span class=s2>            if item_value is None:
</span></span></span><span class=line><span class=cl><span class=s2>                print_warning(&#34;[Packet.get] Item &#34; + item + &#34; is None&#34;)
</span></span></span><span class=line><span class=cl><span class=s2>                return -1
</span></span></span><span class=line><span class=cl><span class=s2>            final_packet += item_value
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>final_packet</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define packet structure below</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Header</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>magic_value</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>session_id</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>command</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>unused</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>body_size</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>body_args</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_packet_hello</span><span class=p>(</span><span class=n>sock</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>Packet</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>magic_value</span>    <span class=o>=</span> <span class=n>get_word</span><span class=p>(</span><span class=mh>0xff66</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>session_id</span>     <span class=o>=</span> <span class=n>get_word</span><span class=p>(</span><span class=mh>0x101</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>command</span>        <span class=o>=</span> <span class=n>get_byte</span><span class=p>(</span><span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>unused</span>         <span class=o>=</span> <span class=n>get_byte</span><span class=p>(</span><span class=mh>0x44</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>body_size</span>      <span class=o>=</span> <span class=n>get_word</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>body_args</span>      <span class=o>=</span> <span class=nb>bytearray</span><span class=p>([</span><span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>packet</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ff</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/tmp/req1&#34;</span><span class=p>,</span><span class=s2>&#34;wb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ff</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>packet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ff</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Sending ..&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>packet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Receiving ..&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ff</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/tmp/res1&#34;</span><span class=p>,</span><span class=s2>&#34;wb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ff</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ff</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># retrieve the encryption key</span>
</span></span><span class=line><span class=cl>    <span class=n>enc_key</span> <span class=o>=</span> <span class=n>res</span><span class=p>[</span><span class=mi>9</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>enc_key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt_string</span><span class=p>(</span><span class=n>string</span><span class=p>,</span> <span class=n>enc_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>xor_result</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>chr</span><span class=p>(</span><span class=nb>ord</span><span class=p>(</span><span class=n>char</span><span class=p>)</span> <span class=o>^</span> <span class=n>enc_key</span><span class=p>)</span> <span class=k>for</span> <span class=n>char</span> <span class=ow>in</span> <span class=n>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>xor_result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decrypt_string</span><span class=p>(</span><span class=n>string_bytes</span><span class=p>,</span> <span class=n>enc_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>v_byte</span> <span class=ow>in</span> <span class=n>string_bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=n>v_byte</span> <span class=o>^</span> <span class=n>enc_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_packet_exec</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>enc_key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>Packet</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>magic_value</span>    <span class=o>=</span> <span class=n>get_word</span><span class=p>(</span><span class=mh>0xff66</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>session_id</span>     <span class=o>=</span> <span class=n>get_word</span><span class=p>(</span><span class=mh>0x101</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>command</span>        <span class=o>=</span> <span class=n>get_byte</span><span class=p>(</span><span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>unused</span>         <span class=o>=</span> <span class=n>get_byte</span><span class=p>(</span><span class=mh>0x01</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Create the encrypted arguments body</span>
</span></span><span class=line><span class=cl>    <span class=n>pp</span>                      <span class=o>=</span> <span class=s2>&#34;read&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span>                 <span class=o>=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>pp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span>                 <span class=o>+=</span> <span class=n>encrypt_string</span><span class=p>(</span><span class=n>pp</span><span class=p>,</span> <span class=n>enc_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pp</span>                      <span class=o>=</span> <span class=s2>&#34;/home/pwnx/flag.txt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span>                 <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>pp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span>                 <span class=o>+=</span> <span class=n>encrypt_string</span><span class=p>(</span><span class=n>pp</span><span class=p>,</span> <span class=n>enc_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pp</span>                      <span class=o>=</span> <span class=s2>&#34;0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span>                 <span class=o>+=</span> <span class=nb>chr</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>pp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span>                 <span class=o>+=</span> <span class=n>encrypt_string</span><span class=p>(</span><span class=n>pp</span><span class=p>,</span> <span class=n>enc_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>encrypted_body</span>          <span class=o>=</span> <span class=nb>bytearray</span><span class=p>(</span><span class=n>payload</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-8&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>body_size</span>      <span class=o>=</span> <span class=n>get_word</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>encrypted_body</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span><span class=o>.</span><span class=n>header</span><span class=o>.</span><span class=n>body_args</span>      <span class=o>=</span> <span class=n>encrypted_body</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>packet</span> <span class=o>=</span> <span class=n>p</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ff</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/tmp/req2&#34;</span><span class=p>,</span><span class=s2>&#34;wb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ff</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>packet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ff</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>packet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>file_content</span> <span class=o>=</span> <span class=n>decrypt_string</span><span class=p>(</span><span class=n>res</span><span class=p>[</span><span class=mi>8</span><span class=p>:],</span> <span class=n>enc_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] File content: &#34;</span> <span class=o>+</span> <span class=n>file_content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ff</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/tmp/res2&#34;</span><span class=p>,</span><span class=s2>&#34;wb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ff</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ff</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>print_error</span><span class=p>(</span><span class=s2>&#34;Needed parameters&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>target</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>target</span><span class=p>,</span><span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>enc_key</span> <span class=o>=</span> <span class=n>send_packet_hello</span><span class=p>(</span><span class=n>sock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Encryption key found: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>enc_key</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1># reconnect</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sock</span><span class=o>.</span><span class=n>connect</span><span class=p>((</span><span class=n>target</span><span class=p>,</span><span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>send_packet_exec</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>enc_key</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Result:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ python3 exploit.py &lt;ip&gt; &lt;port&gt;
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Sending ..
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Receiving ..
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Encryption key found: 0x2e
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> File content: PWNX<span class=o>{</span>67ef535c2d1a5eea75b21091bd5d2e18eedf9f5c5abd61aa73b0110522666ab3<span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></article><hr><div id=contact_buttons><footer><p>Powered by <a href=https://github.com/jackyzha0/quartz>Quartz</a>, Â© 2025</p><ul><li><a href=https://1day.dev/>Home</a></li><li><a href=https://twitter.com/kiks7_7>Twitter</a></li><li><a href=https://github.com/kiks7>Github</a></li><li><a href=https://linkedin.com/in/alessandro-groppo-1a0429146>Linkedin</a></li></ul></footer></div></div></body></html>